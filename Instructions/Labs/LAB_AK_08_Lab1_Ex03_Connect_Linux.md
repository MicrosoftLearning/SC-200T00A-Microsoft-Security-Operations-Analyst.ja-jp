---
lab:
  title: 演習 3 - データ コネクタを使用して Microsoft Sentinel に Linux ホストを接続する
  module: Learning Path 8 - Connect logs to Microsoft Sentinel
---

# ラーニング パス 8 - ラボ 1 - 演習 3 - データ コネクタを使用して Microsoft Sentinel に Linux ホストを接続する

## ラボのシナリオ

![ラボの概要。](../Media/SC-200-Lab_Diagrams_Mod6_L1_Ex3.png)

あなたは、Microsoft Sentinel を実装した会社で働いているセキュリティ運用アナリストです。 組織内の多くのデータ ソースからのログ データを接続する方法について学習する必要があります。 これには、AMA 経由の Common Event Format (CEF) データ コネクタとレガシ エージェント経由の Syslog データ コネクタを使用した Linux 仮想マシンのデータ ソースが含まれます。

>**重要:** ラーニング パス #8 のラボ演習は、*スタンドアロン*環境にあります。 ラボを完了せずに終了する場合は、構成を再実行する必要があります。

### このラボの推定所要時間: 30 分

>**重要:** 別の仮想マシンで実行される次のタスク内の手順があります。 仮想マシン名の参照を探します。

### タスク 1:Microsoft Sentinel ワークスペースにアクセスする

このタスクでは、Microsoft Sentinel ワークスペースにアクセスします。

>**注:** Microsoft Sentinel は、**defenderWorkspace** という名前で Azure サブスクリプションに事前にデプロイされており、必要な*コンテンツ ハブ* ソリューションがインストールされています。

1. 管理者として **WIN1** 仮想マシンにログインします。パスワードは **Pa55w.rd** です。  

1. 新しい Microsoft Edge ブラウザーを起動します。

1. Edge ブラウザーで、Azure portal (<https://portal.azure.com> ) に移動します。

1. **サインイン** ダイアログ ボックスで、ラボ ホスティング プロバイダーから提供された**テナントの電子メール** アカウントをコピーして貼り付け、**[次へ]** を選択します。

1. **[パスワードの入力]** ダイアログ ボックスで、ラボ ホスティング プロバイダーから提供された**テナントパスワード**をコピーして貼り付け、**[サインイン]** を選択します。

    >**注:**  password.ssh の代わりに "一時アクセス パス" (TAP) を入力するように求められる場合があります**

1. Azure portal の検索バーに「*Sentinel*」と入力してから、**[Microsoft Sentinel]** を選択します。

1. Microsoft Sentinel **defenderWorkspace** を選択します。

### タスク 2:共通イベント形式のコネクタを使用して Linux ホストを接続する

このタスクでは、AMA 経由の Common Event Format (CEF) データ コネクタを使用して Linux ホストを Microsoft Sentinel に接続します。 また、イベントを収集するデータ収集ルール (DCR) も作成します。 AZURE Arc は、DCR を作成するために必要に応じて、この Linux ホストにプレインストールされています。

1. **LIN1** 仮想マシンを起動します。 ラボ ホスト側によって提供されるユーザー名とパスワードを使用してログインします。 **ヒント:** ログイン プロンプトを表示するには Enter キーを押す必要がある場合があり、*ユーザー名とパスワード*を書き留めておくことをお勧めします。

1. LIN1 サーバー IP アドレスを書き留めます。 例として次のスクリーンショットをご覧ください。

    ![Linux ログイン](../Media/LinuxLoginExample.png)

1. **WIN1** 仮想マシンに戻ります。 新しい Microsoft Edge ブラウザーを起動します。

1. タスク バーの検索フォームに **Windows PowerShell** と入力して、**Windows PowerShell** を選択します。

1. 次の PowerShell コマンドを入力し、特定の Linux サーバー情報に合わせて調整し、Enter キーを押します。

    ```PowerShell
    ssh insert-your-linux-IP-address-here -l insert-linux-user-name-here
    ```

1. *[はい]* を入力して接続を確認し、ユーザーのパスワードを入力して、Enter キーを押します。 画面は次のようになります。

    ![Linux ログイン](../Media/PSconnectLinux.png)

1. SSH セッションの Linux プロンプトで、次のコマンドを入力します。 *Enter キーを押さないでください*

    ```cmd
    azcmagent connect -g "defender-RG" -l "EastUS" -s "Subscription ID string"
    ```

1. **サブスクリプション ID 文字列** を、ラボ ホスト (*リソース タブ) から提供された *サブスクリプション ID* に置き換えます。 引用符は保持してください。

1. **Enter** を入力してコマンドを実行します (これには数分かかる場合があります)。

1. "*サインインするには、Web ブラウザーを使用してページ <https://microsoft.com/devicelogin> を開き、コード...*" メッセージで、Ctrl キーを押しながらリンクをクリックして、デバイス ログイン ページを開きます。 提供されたコードをコピーし、*[アクセス許可コードの入力]* ボックスに貼り付けて、**[次へ]** を選択します。

    ![Linux azcmagent デバイス ログイン](../Media/device-login.png)

1. *[アカウントの選択]* ダイアログ ボックスで、ラボ ホスティング プロバイダーから提供された**テナントのメール アドレス**を選択します。 *認証が完了*したというメッセージが表示されるまで待ち、ブラウザー タブを閉じて、*コマンド プロンプト* ウィンドウに戻ります。 または、*[サインイン]* ダイアログ ボックスが表示された場合は、ラボ ホスティング プロバイダーから提供された**テナントのメール アドレス**と**テナントのパスワード**を入力して、**[サインイン]** を選択します。 *認証が完了*したというメッセージが表示されるまで待ち、ブラウザー タブを閉じて、*コマンド プロンプト* ウィンドウに戻ります。

    >**注:**  パスワードの代わりに "一時アクセス パス" (TAP) を入力するように求められる場合があります。**

1. コマンドの実行が完了したら、*コマンド プロンプト* ウィンドウを開いたままにし、次のコマンドを入力して接続が成功したことを確認します。

    ```cmd
    azcmagent show
    ```

1. コマンド出力で、*Agent status* が **Connected** であることを確認します。 *PowerShell コマンド プロンプト* ウィンドウを閉じないでください。

1. 新しい Microsoft Edge ブラウザーを起動します。

1. Edge ブラウザーで、Azure portal (<https://portal.azure.com> ) に移動します。

1. **サインイン** ダイアログ ボックスで、ラボ ホスティング プロバイダーから提供された**テナントの電子メール** アカウントをコピーして貼り付け、**[次へ]** を選択します。

1. **[パスワードの入力]** ダイアログ ボックスで、ラボ ホスティング プロバイダーから提供された**テナントパスワード**をコピーして貼り付け、**[サインイン]** を選択します。

    >**注:**  パスワードの代わりに "一時アクセス パス" (TAP) を入力するように求められる場合があります。**

1. Azure portal の検索バーに「*Sentinel*」と入力してから、**[Microsoft Sentinel]** を選択します。

1. Microsoft Sentinel **defenderWorkspace** を選択します。

1. Microsoft Sentinel の左側ナビゲーション メニューで、*[コンテンツ管理]* セクションまで下にスクロールし、**[コンテンツ ハブ]** を選択します。

1. *[コンテンツ ハブ]* で、「**Common Event Format**」ソリューションを検索し、一覧から選択します。

1. *Common Event Format* ソリューションのページで、**[管理]** を選択します。

    >**注:***Common Event Format* ソリューションでは、*AMA 経由の Common Events Format (CEF)* データ コネクタと*レガシ エージェント経由の Common Event Format (CEF)* データ コネクタの両方がインストールされます。

1. *AMA 経由の Common Event Format (CEF)* データ コネクタを選択し、コネクタ情報ブレードの **[コネクタ ページを開く]** を選択します。

1. *[構成]* セクションで、**[+ データ収集ルールの作成]** ボタンを選択します。

1. *[データ収集ルールの作成]* ページの *[基本]* タブで、[ルール名] に「**AZLINDCR**」と入力し、**[次へ:リソース]** を選択します。

1. *[リソース]* タブで、*[スコープ]* の下の *[MOC サブスクリプション]* を展開します。

    >**ヒント:***[スコープ]* 列の前にある ">" を選択することで、*[スコープ]* 階層全体を展開できます。

1. **defender-RG** を展開してから、**LIN1** を選択します。

    >**注:** *LIN1* 仮想マシンは、ubuntuxxx のような別の名前で表示される場合があります。

1. **[次へ: 接続]** を選択します。 *[収集]* タブで、*[LOG_ALERT]* ドロップダウン メニューを選択し、**LOG_WARNING** を選択します。

1. **[次へ: 確認および作成]** を選択し、**[作成]** を選択します。 デプロイが完了するまで待ちます。

    >**注:** 場合によっては、ページを更新する必要があります。

1. *AMA 経由の Common Event Format (CEF)* データ コネクタに**接続済み**と表示されるはずです。

1. 次に、[構成] セクションで、[クリップボードにコピー] アイコンを使用して、AMA フォワーダーをインストールするスクリプトをコピーします。

1. *PowerShell コマンド プロンプト* ウィンドウに戻ります。 引き続き LIN2 仮想マシンに接続している必要があります。

1. Linux プロンプトで、前の手順でコピーした AMA フォワーダー インストール スクリプトを貼り付けます。

1. LIN2 マシンにインストールされている正しい *Python* バージョンに合わせてスクリプトを編集する必要があります。

1. *python Forwarder_AMA_installer.py* コマンドを含むスクリプト セクションを *python3 Forwarder_AMA_installer.py* に変更します。

1. **Enter** キーを押してスクリプトを実行します

1. "インストールが正常に完了しました" というメッセージが表示されます。**

1. Linux プロンプトで以下のコマンドを入力し、Enter キーを押します。

    ```cmd
    netstat -lnptv
    ```

1. rsyslog (または syslog-ng) デーモンがポート 514 でリッスンしていることがわかります。

    >**注:** *CommonSecurityLog* テーブルに対してクエリを実行して CEF イベントを検索できます。

1. 「**exit**」と入力して、LIN1 へのリモート シェル接続を閉じます。

### タスク 3:Syslog コネクタを使用して Linux ホストを接続する

このタスクでは、Linux ホストを Syslog コネクタを使用して Microsoft Sentinel に接続します。

1. **LIN2** 仮想マシンを起動します。 ラボ ホスト側によって提供されるユーザー名とパスワードを使用してログインします。 **ヒント:** ログイン プロンプトを表示するには Enter キーを押す必要がある場合があり、*ユーザー名とパスワード*を書き留めておくことをお勧めします。

1. LIN2 サーバー IP アドレスを書き留めます。 例として次のスクリーンショットをご覧ください。

    ![Linux ログイン](../Media/LinuxLoginExample.png)

1. **WIN1** 仮想マシンに戻ります。 新しい Microsoft Edge ブラウザーを起動します。

1. タスク バーの検索フォームに **Windows PowerShell** と入力して、**Windows PowerShell** を選択します。

1. 次の PowerShell コマンドを入力し、特定の Linux サーバー情報に合わせて調整し、Enter キーを押します。

    ```PowerShell
    ssh insert-your-linux-IP-address-here -l insert-linux-user-name-here
    ```

1. *[はい]* を入力して接続を確認し、ユーザーのパスワードを入力して、Enter キーを押します。 画面は次のようになります。

    ![Linux ログイン](../Media/PSconnectLinux.png)

1. SSH セッションの Linux プロンプトで、次のコマンドを入力します。 *Enter キーを押さないでください*

    ```cmd
    azcmagent connect -g "defender-RG" -l "EastUS" -s "Subscription ID string"
    ```

1. **サブスクリプション ID 文字列** を、ラボ ホスト (*リソース タブ) から提供された *サブスクリプション ID* に置き換えます。 引用符は保持してください。

1. **Enter** を入力してコマンドを実行します (これには数分かかる場合があります)。

1. "*サインインするには、Web ブラウザーを使用してページ <https://microsoft.com/devicelogin> を開き、コード...*" メッセージで、Ctrl キーを押しながらリンクをクリックして、デバイス ログイン ページを開きます。 提供されたコードをコピーし、*[アクセス許可コードの入力]* ボックスに貼り付けて、**[次へ]** を選択します。

    ![Linux azcmagent デバイス ログイン](../Media/device-login.png)

1. *[アカウントの選択]* ダイアログ ボックスで、ラボ ホスティング プロバイダーから提供された**テナントのメール アドレス**を選択します。 *認証が完了*したというメッセージが表示されるまで待ち、ブラウザー タブを閉じて、*コマンド プロンプト* ウィンドウに戻ります。 または、*[サインイン]* ダイアログ ボックスが表示された場合は、ラボ ホスティング プロバイダーから提供された**テナントのメール アドレス**と**テナントのパスワード**を入力して、**[サインイン]** を選択します。 *認証が完了*したというメッセージが表示されるまで待ち、ブラウザー タブを閉じて、*コマンド プロンプト* ウィンドウに戻ります。

    >**注:**  パスワードの代わりに "一時アクセス パス" (TAP) を入力するように求められる場合があります。**

1. コマンドの実行が完了したら、*コマンド プロンプト* ウィンドウを開いたままにし、次のコマンドを入力して接続が成功したことを確認します。

    ```cmd
    azcmagent show
    ```

1. コマンド出力で、*Agent status* が **Connected** であることを確認します。 *PowerShell コマンド プロンプト* ウィンドウを閉じないでください。

1. SSH セッションを開いたままにし、**WIN1** 仮想マシンに戻ります。

1. 新しい Microsoft Edge ブラウザーを起動します。

1. Edge ブラウザーで、Azure portal (<https://portal.azure.com> ) に移動します。

1. **サインイン** ダイアログ ボックスで、ラボ ホスティング プロバイダーから提供された**テナントの電子メール** アカウントをコピーして貼り付け、**[次へ]** を選択します。

1. **[パスワードの入力]** ダイアログ ボックスで、ラボ ホスティング プロバイダーから提供された**テナントパスワード**をコピーして貼り付け、**[サインイン]** を選択します。

    >**注:**  password.ssh の代わりに "一時アクセス パス" (TAP) を入力するように求められる場合があります**

1. Azure portal の検索バーに「*Sentinel*」と入力してから、**[Microsoft Sentinel]** を選択します。

1. Microsoft Sentinel **defenderWorkspace** を選択します。

1. Microsoft Sentinel の左側ナビゲーション メニューで、*[コンテンツ管理]* セクションまで下にスクロールし、**[コンテンツ ハブ]** を選択します。

1. *[コンテンツ ハブ]* で、「**Syslog**」ソリューションを検索し、一覧から選択します。

1. *Syslog* のソリューション ページで、**[管理]** を選択します。

    >**注:** *Syslog* ソリューションでは、2 つの *Syslog* データ コネクタ、7 つの分析ルール、9 つのハンティング クエリ、2 つのパーサー、21 のブックがインストールされます。

1. コネクタ情報ブレードで、[Syslog via AMA] データ コネクタを選択し、**[コネクタ ページを開く]** を選択します**

1. [構成] セクションで、**[+ データ収集ルールの作成]** を選択します。**

1. [データ収集ルールの作成] ページの [基本] タブで、[ルール名] に「**AZLINDCR2**」と入力し、**[次へ: **** リソース]** を選択します。

1. *[リソース]* タブで、*[スコープ]* の下の *[MOC サブスクリプション]* を展開します。

    >**ヒント:***[スコープ]* 列の前にある ">" を選択することで、*[スコープ]* 階層全体を展開できます。

1. **[defender-RG]** を展開し、**[LIN2]** を選択します。

    >**注:**  *LIN2* 仮想マシンは、ubuntuxxx などの別の名前で表示される場合があります。

1. **[次へ: 接続]** を選択します。 *[収集]* タブで、*[LOG_ALERT]* ドロップダウン メニューを選択し、**LOG_WARNING** を選択します。

1. **[次へ: 確認および作成]** を選択し、**[作成]** を選択します。 デプロイが完了するまで待ちます。

1. [Syslog via AMA] データ コネクタが **[接続済み]** と表示されるようになりました。**

    >**注:** 場合によっては、ページを更新する必要があります。

1. 次に、[構成] セクションで、[クリップボードにコピー] アイコンを使用して、AMA フォワーダーをインストールするスクリプトをコピーします。

1. *PowerShell コマンド プロンプト* ウィンドウに戻ります。 引き続き LIN2 仮想マシンに接続している必要があります。

1. Linux プロンプトで、前の手順でコピーした AMA フォワーダー インストール スクリプトを貼り付けます。

1. LIN2 マシンにインストールされている正しい *Python* バージョンに合わせてスクリプトを編集する必要があります。

1. *python Forwarder_AMA_installer.py* コマンドを含むスクリプト セクションを *python3 Forwarder_AMA_installer.py* に変更します。

1. **Enter** キーを押してスクリプトを実行します

1. "インストールが正常に完了しました" というメッセージが表示されます。**

1. Linux プロンプトで以下のコマンドを入力し、Enter キーを押します。

    ```cmd
    netstat -lnptv
    ```

1. rsyslog (または syslog-ng) デーモンがポート 514 でリッスンしていることがわかります。

    >**注:**  [Syslog] テーブルで Syslog イベントのクエリを実行できます。**

1. 「**exit**」と入力して、LIN1 へのリモート シェル接続を閉じます。

## 演習 4 に進む
