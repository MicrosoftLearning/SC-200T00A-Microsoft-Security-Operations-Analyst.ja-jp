---
lab:
  title: 演習 1 - Microsoft Sentinel で脅威ハンティングを実行する
  module: Learning Path 8 - Perform threat hunting in Microsoft Sentinel
---

# ラーニング パス 8 - ラボ 1 - 演習 1 - Microsoft Sentinel で脅威ハンティングを実行する

## ラボのシナリオ

![ラボの概要。](../Media/SC-200-Lab_Diagrams_Mod8_L1_Ex1.png)

あなたは、Microsoft Sentinel を実装した会社で働いているセキュリティ運用アナリストです。 コマンドと制御 (C2 または C&C) 手法に関する脅威インテリジェンスを受け取りました。 その脅威に対して捜索とウォッチを実行する必要があります。

>**重要:** このラボで使用されるログ データは、前のモジュールで作成されたものです。 演習 5 の WIN1 サーバーの**攻撃 3** を参照してください。

>**注:**  前のモジュールでデータを探索するプロセスを既に経験しているため、このラボでは最初に KQL ステートメントが提供されます。 

>                **メモ:** このラボをご自分のペースでクリックして進めることができる、 **[ラボの対話型シミュレーション](https://mslabs.cloudguides.com/guides/SC-200%20Lab%20Simulation%20-%20Perform%20threat%20hunting%20in%20Microsoft%20Sentinel)** が用意されています。 対話型シミュレーションとホストされたラボの間に若干の違いがある場合がありますが、示されている主要な概念とアイデアは同じです。 


### タスク 1:ハンティング クエリの作成

このタスクでは、捜索クエリを作成し、結果をブックマークして、ライブ ストリームを作成します。

1. 管理者として WIN1 仮想マシンにログインします。パスワードは**Pa55w.rd**。  

1. Edge ブラウザーで、Azure portal (https://portal.azure.com ) に移動します。

1. **[サインイン]** ダイアログ ボックスで、ラボ ホスティング プロバイダーから提供された**テナントの電子メール** アカウントをコピーして貼り付け、 **[次へ]** を選択します。

1. **[パスワードの入力]** ダイアログ ボックスで、ラボ ホスティング プロバイダーから提供された**テナントのパスワード**をコピーして貼り付け、 **[サインイン]** を選択します。

1. Azure portal の検索バーに「*Sentinel*」と入力してから、**[Microsoft Sentinel]** を選択します。

1. Microsoft Sentinel ワークスペースを選択します。

1. **[ログ]** を選択します。 

1. *[新しいクエリ 1]* スペースに以下の KQL ステートメントを入力します。

   >**重要:** 最初に KQL クエリをメモ帳に貼り付けて、そこから *[新しいクエリ 1]* ログ ウィンドウにコピーしてエラーを回避してください。

    ```KQL
    let lookback = 2d; 
    SecurityEvent 
    | where TimeGenerated >= ago(lookback) 
    | where EventID == 4688 and Process =~ "powershell.exe"
    | extend PwshParam = trim(@"[^/\\]*powershell(.exe)+" , CommandLine) 
    | project TimeGenerated, Computer, SubjectUserName, PwshParam 
    | summarize min(TimeGenerated), count() by Computer, SubjectUserName, PwshParam 
    | order by count_ desc nulls last 
    ```

1. さまざまな結果を確認します。 これで、環境内で実行されている PowerShell 要求が特定されました。

1. *"-file c2.ps1"* を示す結果のチェック ボックスをオンにします。

1. 中央のコマンド バーで、**[ブックマークの追加]** ボタンを選択します。

1. *[エンティティ マッピング]* で **[+ 新しいエンティティの追加]** を選択します。

1. *[エンティティ]* で、 **[ホスト]** を選択してから、その値として **[ホスト名]** と **[コンピューター]** を選びます。

1. *[戦術と手法]* で、 **[コマンドとコントロール]** を選択します。

1. *[ブックマークの追加]* ブレードに戻り、 **[作成]** を選択します。 このブックマークは後でインシデントにマップします。

1. ウィンドウの右上にある **[X]** を選択して *[ログ]* ウィンドウを閉じ、 **[OK]** を選択して変更を破棄します。 

1. Microsoft Sentinel ワークスペースをもう一度選択し、 *[脅威の管理]* 領域で **[ハンティング]** ページを選択します。

1. コマンド バーから **[クエリ]** タブ、 **[+ 新しいクエリ]** の順に選択します。

1. *[カスタム クエリの作成]* ウィンドウで、 *[名前]* に「**PowerShell ハント**」と入力します。

1. *カスタム クエリ*には、次の KQL ステートメントを入力します。

    ```KQL
    let lookback = 2d; 
    SecurityEvent 
    | where TimeGenerated >= ago(lookback) 
    | where EventID == 4688 and Process =~ "powershell.exe"
    | extend PwshParam = trim(@"[^/\\]*powershell(.exe)+" , CommandLine) 
    | project TimeGenerated, Computer, SubjectUserName, PwshParam 
    | summarize min(TimeGenerated), count() by Computer, SubjectUserName, PwshParam 
    | order by count_ desc nulls last 
    ```

1. 下にスクロールし、 *[エンティティ マッピング]* で次のように選択します。

    - *[エンティティの種類]* ドロップダウン リストで、**[ホスト]** を選択します。
    - *[識別子]* ドロップダウン リストで、**[HostName]** を選択します。
    - *[値]* ドロップダウン リストで、 **[コンピューター]** を選択します。

1. 下にスクロールし、*[戦術と手法]* で **[コマンドと制御]** を選び、**[作成]** を選択してハンティング クエリを作成します。

1. *[Microsoft Sentinel | ハンティング]* ブレードで、先ほど作成したクエリ *PowerShell ハント*をリストで探します。

1. リストから **[PowerShell ハント]** を選択します。

1. 中央のペインの *[結果]* 列で結果の数を確認します。

1. 右側のペインから **[結果の表示]** ボタンを選択します。 KQL クエリが自動的に実行されます。

1. ウィンドウの右上にある **[X]** を選択して *[ログ]* ウィンドウを閉じ、 **[OK]** を選択して変更を破棄します。 

1. **[PowerShell ハント]** を右クリックし、 **[ライブストリームに追加]** を選択します。 **ヒント:** これは、右にスライドし、行の末尾にある省略記号 **(...)** を選択してコンテキスト メニューを開くことで行うこともできます。

1. *[状態]* が *[実行中]* になったことを確認します。 これはバックグラウンドで 30 秒ごとに実行され、新しい結果が見つかると Azure Portal (ベル アイコン) で通知を受け取ります。 

1. 中央のペインで **[ブックマーク]** タブを選択します。

1. 結果リストで先ほど作成したブックマークを選択します。

1. 右側のペインで下にスクロールし、 **[調査]** ボタンを選択します。 **ヒント:** 調査グラフを表示するには数分かかる場合があります。

1. 前のモジュールで行ったのと同じように調査グラフを調べます。 *WINServer* の *[関連するアラート]* の数が多いことに注目してください。

1. ウィンドウの右上にある **[X]** を選択して、 *[調査]* グラフ ウィンドウを閉じます。 

1. **[>>]** アイコンを選択して右側のブレードを非表示にし、省略記号 **(...)** アイコンが表示されるまで右にスクロールします。

1. **[既存のインシデントに追加]** を選択します。 すべてのインシデントが右側のペインに表示されます。

1. インシデントの 1 つを選んでから、 **[追加]** を選択します。 

1. 左にスクロールして、 *[重大度]* 列にインシデントのデータが設定されていることに注目します。


### タスク 2:NRT クエリ ルールを作成する

このタスクでは、LiveStream を使用する代わりに、NRT 分析クエリ ルールを作成します。 NRT ルールは 1 分ごとに実行され、1 分間ルックバックされます。 NRT ルールの利点は、アラートとインシデント作成ロジックを使用できることです。

1. Microsoft Sentinel で *[構成]* の **[分析]** ページを選択します。 

1. **[作成]** タブを選択し、 **[NRT クエリ ルール (プレビュー)]** を選択します。

1. これで [分析ルール ウィザード] が起動します。 *[全般]* タブで、次のように入力します。

    |設定|値|
    |---|---|
    |名前|**NRT PowerShell ハント**|
    |説明|**NRT PowerShell ハント**|
    |方針|**コマンドとコントロール**|
    |Severity|**高**|

1. **[次へ: ルール ロジックを設定]** ボタンを選択します。 

1. *[ルール クエリ]* に次の KQL ステートメントを入力します。

    ```KQL
    let lookback = 2d; 
    SecurityEvent 
    | where TimeGenerated >= ago(lookback) 
    | where EventID == 4688 and Process =~ "powershell.exe"
    | extend PwshParam = trim(@"[^/\\]*powershell(.exe)+" , CommandLine) 
    | project TimeGenerated, Computer, SubjectUserName, PwshParam 
    | summarize min(TimeGenerated), count() by Computer, SubjectUserName, PwshParam
    ```

1. **[クエリ結果の表示 >]** を選択して、クエリにエラーがないことを確認します。

1. ウィンドウの右上にある **[X]** を選択して *[ログ]* ウィンドウを閉じ、 **[OK]** を選択して変更を破棄します。 

1. *[結果のシミュレーション]* の **[現在のデータでテストする]** を選択します。 *[1 日あたりのアラート]* の予想される数に注目してください。

1. *[エンティティ マッピング]* で、次のように選択します。

    - *[エンティティの種類]* ドロップダウン リストで、**[ホスト]** を選択します。
    - *[識別子]* ドロップダウン リストで、**[HostName]** を選択します。
    - *[値]* ドロップダウン リストで、 **[コンピューター]** を選択します。

1. 下にスクロールし、 **[次へ: インシデント設定>]** ボタンを選択します。

1. *[インシデント設定]* タブについては、既定値のままにし、 **[次へ: 確認と作成 >]** ボタンを選択します。

1. *[確認と作成]* タブで、 **[保存]** ボタンを選択して、新しいスケジュール化された分析ルールを作成して保存します。

### タスク 3:検索の作成

このタスクでは、検索ジョブを使用して C2 を検索します。 

1. Microsoft Sentinel で、 *[全般]* の **[検索]** ページを選択します。 

1. 検索ボックスに「**reg.exe**」と入力してから、 **[スタート]** を選択します。 

1. クエリを実行している新しいウィンドウが開きます。 右上にある省略記号アイコン **(...)** を選択し、 **[検索ジョブ モード]** を切り替えます。

1. コマンド バーから **[検索ジョブ]** ボタンを選択します。 

1. 検索ジョブでは、結果が到着するとすぐに新しいテーブルが作成されます。 結果は、 *[保存された検索条件]* タブから確認できます。

1. ウィンドウの右上にある **[X]** を選択して *[ログ]* ウィンドウを閉じ、 **[OK]** を選択して変更を破棄します。 
 
1. コマンド バーから **[復元]** タブを選び、 **[復元]** ボタンを選択します。

1. *[復元するテーブルの選択]* で、**SecurityEvent** を検索して選択します。

1. 使用可能なオプションを確認し、 **[復元]** ボタンを選択します。

1. 復元ジョブは数分間実行され、データは新しいテーブルで使用できるようになります。

    >**重要:** 復元ジョブは、対話型ログではなく、アーカイブ データの復旧に使用する必要があります。

## 演習 2 に進みます。
