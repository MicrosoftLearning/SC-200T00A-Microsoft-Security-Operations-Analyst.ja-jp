---
lab:
  title: 演習 2 - データ コネクタを使用して Microsoft Sentinel に Windows デバイスを接続する
  module: Learning Path 8 - Connect logs to Microsoft Sentinel
---

# ラーニング パス 8: ラボ 1: 演習 2: データ コネクタを使用して Microsoft Sentinel に Windows デバイスを接続する

## ラボのシナリオ

![ラボの概要。](../Media/SC-200-Lab_Diagrams_Mod6_L1_Ex2.png)

あなたは Microsoft Sentinel を実装した企業で働いているセキュリティ運用アナリストです。 組織内の多くのデータ ソースからのログ データを接続する方法について学習する必要があります。 データの次のソースは、オンプレミス環境や他のパブリック クラウドなど、Azure の内部および外部にある Windows 仮想マシンです。

>**重要:** ラーニング パス #8 のラボ演習は、*スタンドアロン*環境にあります。 ラボを完了せずに終了する場合は、構成を再実行する必要があります。

### このラボの推定所要時間: 30 分

### タスク 1:Azure で Windows 仮想マシンを作成する

このタスクでは、Azure で Windows 仮想マシンを作成します。

1. 管理者として **WIN1** 仮想マシンにログインします。パスワードは **Pa55w.rd** です。  

1. Microsoft Edge ブラウザーで、Azure portal (<https://portal.azure.com> ) に移動します。

1. **サインイン** ダイアログ ボックスで、ラボ ホスティング プロバイダーから提供された**テナントの電子メール** アカウントをコピーして貼り付け、**[次へ]** を選択します。

1. **[パスワードの入力]** ダイアログ ボックスで、ラボ ホスティング プロバイダーから提供された**テナント パスワード**をコピーして貼り付け、**[サインイン]** を選択します。

1. **[+ リソースの作成]** を選択します。 **ヒント:** 既に Azure Portal にいた場合は、上部のバーから *[Microsoft Azure]* を選択してホームに移動する必要があることがあります。

1. **[サービスとマーケットプレースの検索]** ボックスに「*Windows 10*」と入力し、ドロップダウン リストから **[Microsoft Window 10]** を選択します。

1. **Microsoft Window 10** のボックスをオンにします。

1. [プラン] ドロップダウン リストを開き、 **[Windows 10 Enterprise バージョン 22H2]** を選択します。**

1. **[事前設定された構成で開始する]** を選択して続行します。

1. **[開発/テスト]** を選択してから、**[VM の作成を続行する]** を選びます。

1. *[リソース グループ]* で **[新規作成]** を選択し、[名前] に「RG-AZWIN01」と入力して **[OK]** を選択します。

    >**注:**  これは、追跡目的の新しいリソース グループとなります。 

1. *[仮想マシン名]* に、「AZWIN01」と入力します。

1. *[リージョン]* の既定値は **[(米国) 米国東部]** のままにします。

1. 下にスクロールして、仮想マシンの [イメージ] を確認します。** 空の場合は、 **[Windows 10 Enterpriseバージョン 22H2]** を選択します。

1. 仮想マシンの [サイズ] を確認します。** 空の場合は、 **[すべてのサイズを表示]** を選択し、 *[Azure ユーザーが最もよく使用]* で最初の VM サイズを選択し、 **[選択]** を選択します。

    >**注:** 次のメッセージが表示される場合: *This image is not supported for Azure Automanage. To disable this feature,navigate to the Management tab. Otherwise, select a supported image.* (このイメージは Azure Automanage ではサポートされていません。この機能を無効にするには、[管理] タブに移動してください。それ以外の場合は、サポートされているイメージを選択してください。) [管理] タブに移動し、"Automanage" を無効にします。 その後、作成プロセスは成功するようになります。

1. 下にスクロールし、選んだ [ユーザー名] を入力します。** **ヒント:** admin や root のような予約語は避けてください。

1. 任意の ''*パスワード*'' を入力します。 **ヒント:** テナント パスワードを再利用する方が簡単な場合があります。 これはリソース タブにあります。

1. ページの下部まで下にスクロールし、*[ライセンス]* の下にあるチェックボックスをオンにして、対象ライセンスがあることを確認します。

1. **[確認と作成]** を選択し、検証に合格するまで待ちます。

    >**注:** "ネットワーク" 検証エラーがある場合は、そのタブを選び、その内容を確認してから、 **[確認と作成]** をもう一度選びます。**

1. **［作成］** を選択します リソースが作成されるのを待ちますこれには数分かかることがあります。

### タスク 2: オンプレミスのサーバーに Azure Arc をインストールする

このタスクでは、オンボードを簡単にするために、オンプレミスのサーバーに Azure Arc をインストールします。

>**重要:** 次の手順は、以前に作業していたものとは異なるマシンで行います。 仮想マシン名の参照を探します。

1. 管理者として **WINServer** 仮想マシンにログインします。パスワードは **Passw0rd!** です。 必要に応じて。  

1. Microsoft Edge ブラウザーを開き、Azure portal (<https://portal.azure.com> ) に移動します。

1. **[サインイン]** ダイアログ ボックスで、ラボ ホスティング プロバイダーから提供された**テナントの電子メール** アカウントをコピーして貼り付け、**[次へ]** を選択します。

1. **[パスワードの入力]** ダイアログ ボックスで、ラボ ホスティング プロバイダーから提供された**テナントパスワード**をコピーして貼り付け、**[サインイン]** を選択します。

1. Azure portal の検索バーに「*Arc*」と入力し、**[Azure Arc]** を選択します。

1. ナビゲーション ウィンドウの **[Azure Arc リソース]** の下にある **[マシン]** を選択します

1. **[+ Add/Create] (+ 追加/作成)** を選択し、 **[Add a machine] (マシンの追加)** を選択します。

1. [単一サーバーの追加] セクションから **[スクリプトの生成]** を選択します。

1. *[Azure Arc を使用してサーバーを追加する]* ページで、 *[プロジェクトの詳細]* で先ほど作成したリソース グループを選択します。 **ヒント:** *RG-Defender*

    >**注:**  リソース グループをまだ作成していない場合は、別のタブを開き、リソース グループを作成して最初からやり直します。

1. *[リージョン]* でドロップダウン リストから **[(米国) 米国東部]** を選びます。

1. *[サーバーの詳細]* と *[接続方法]* のオプションを確認します。 既定値のままにして **[次へ]** を選択し、[タグ] タブに移動します。

1. 使用可能な既定のタグを確認します。 **[次へ]** を選択して、[スクリプトのダウンロードと実行] タブに移動します。

1. 下にスクロールし、 **[ダウンロード]** ボタンを選択します。 **ヒント:** ブラウザーでダウンロードがブロックされた場合は、ブラウザーでダウンロードを許可するように対処してください。 Microsoft Edge ブラウザーで、必要に応じて省略記号ボタン ([...]) を選択し、**[保存]** を選択します。

1. Windows の [スタート] ボタンを右クリックし、**[Windows PowerShell (管理者)]** を選択します。

1. UAC プロンプトが表示された場合は、「*Administrator*」を "ユーザー名" として、「*Passw0rd!*」を "パスワード" として入力します。

1. 「cd C:\Users\Administrator\Downloads」と入力します。

    >**重要:** このディレクトリがない場合は、ほとんどの場合、間違ったマシンを使用していることを意味します。 タスク 4 の先頭に戻り、WINServer に変更してやり直します。

1. *Set-ExecutionPolicy -ExecutionPolicy Unrestricted* を入力しEnterキーを押します。

1. [すべてにはい] の場合は「**A**」を入力し、Enter キーを押します。

1. 「*.\OnboardingScript.ps1*」と入力し、Enter キーを押します。  

    >**重要:** *用語 .\OnboardingScript.ps1 が認識されません...* というエラーが表示された場合は、タスク 4 を WINServer 仮想マシンで行っていることを確認してください。 他の問題として、複数回ダウンロードしたためにファイルの名前が変更された可能性があります。実行中のディレクトリで *".\OnboardingScript (1).ps1"* またはその他のファイル番号を検索してください。

1. **R** を入力して 1 回実行し、Enter キーを押します (これには数分かかる場合があります)。

1. セットアップ プロセスにより、Azure Arc エージェントを認証するための新しい Microsoft Edge ブラウザー タブが開きます。 ご自分の管理者アカウントを選択し、"認証が完了しました" というメッセージが表示されるまで待ってから、Windows PowerShell ウィンドウに戻ります。

1. インストールが完了したら、スクリプトをダウンロードした Azure portal ページに戻り、 **[閉じる]** を選択します。 **[Azure Arc を使用してサーバーを追加]** を閉じて、Azure Arc の **[マシン]** ページに戻ります。

1. WINServer サーバー名が表示され、[状態] が *[接続済み]* になるまで **[更新]** を選択します。

    >**注:** これには数分かかることがあります。

### タスク 3: Azure Windows 仮想マシンを接続する

このタスクでは、Azure Windows 仮想マシンを Microsoft Sentinel に接続します。

1. Azure portal の検索バーに「*Sentinel*」と入力してから、**[Microsoft Sentinel]** を選択します。

1. 先ほど作成した Microsoft Sentinel ワークスペースを選択します。

1. 1. Microsoft Sentinel の左側のメニューで、 *[コンテンツ管理]* セクションまで下にスクロールし、 **[コンテンツ ハブ]** を選択します。

1. *[コンテンツ ハブ]* で、「**Windows セキュリティ イベント**」ソリューションを検索し、一覧から選択します。

1. "Windows セキュリティ イベント" のソリューション ページで、 **[インストール]** を選択します。**

1. インストールが完了したら、 **[管理]** を選択します

    >**注:** "Windows セキュリティ イベント" ソリューションでは、"AMA を使用した Windows セキュリティ イベント" と "レガシ エージェントを使用したセキュリティ イベント" データ コネクタの両方がインストールされます。** ** ** さらに、2 つのブック、20 個の分析ルール、43 個のハンティング クエリがインストールされます。

1. "AMA を使用した Windows セキュリティ イベント" データ コネクタを選択し、コネクタ情報ブレードの **[コネクタ ページを開く]** を選択します。**

1. *[構成]* セクションの *[手順]* タブで、 **[データ収集ルールの作成]** を選択します。

1. ルール名に「**AZWINDCR**」と入力して、 **[次へ: リソース]** を選択します。

1. **[+ リソースの追加]** を選択し、作成した仮想マシンを選択します。

1. **RG-AZWIN01** を展開し、**AZWIN01** を選択します。

1. **[適用]** を選んでから、 **[次へ: 収集]** を選びます。

1. 別のセキュリティ イベント コレクション オプションを確認します。 [すべてのセキュリティ イベント] のままにして、 **[次へ: 確認と作成]** を選びます。**

1. **[作成]** を選んで、データ収集ルールを保存します。

1. 少し待ってから **[更新]** を選択すると、新しいデータ収集規則が一覧表示されます。

### タスク 4: 非 Azure Windows マシンを接続する

このタスクでは、Azure Arc に接続された非 Azure Windows 仮想マシンを、Microsoft Sentinel に追加します。  

   >**注:** "AMA を使用した Windows セキュリティ イベント" データ コネクタには非 Azure デバイス用の Azure Arc が必要です。**

1. Microsoft Sentinel ワークスペースの "AMA を使用した Windows セキュリティ イベント" データ コネクタの構成にいることを確認します。**

1. **[手順]** タブの *[構成]* セクションで、"鉛筆" アイコンを選択して **AZWINDCR** の "データ収集ルール" を編集します。** **

1. **[次へ: リソース]** を選択し、*[リソース]* タブの *[スコープ]* の下の *[サブスクリプション]* を展開します。

    >**ヒント:***[スコープ]* 列の前にある ">" を選択することで、*[スコープ]* 階層全体を展開できます。

1. **RG-Defender** (または作成したリソース グループ) を展開して、**WINServer** を選びます。

    >**重要:** WINServer が表示されない場合は、このサーバーに Azure Arc をインストールしたラーニング パス 3、演習 1、タスク 4 を参照してください。

1. **[適用]** を選択します。

1. **[次へ: 収集]** 、 **[次へ: 確認と作成]** の順に選択します。

1. *[検証に成功しました]* が表示されたら、 **[作成]** を選択します。

## 演習 3 に進む
