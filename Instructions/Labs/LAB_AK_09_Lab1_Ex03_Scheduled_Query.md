---
lab:
  title: 演習 3 - テンプレートからスケジュールされたクエリを作成する
  module: Learning Path 9 - Create detections and perform investigations using Microsoft Sentinel
---

# ラーニング パス 9 - ラボ 1 - 演習 3 - テンプレートからスケジュールされたクエリを作成する

## ラボのシナリオ

あなたは Microsoft Sentinel を実装した企業で働いているセキュリティ運用アナリストです。 Azure Sentinel を使って脅威を検出および軽減する方法を学習する必要があります。 データ ソースを Microsoft Sentinel に接続した後、環境内の脅威や異常な動作を検出するのに役立つカスタム分析ルールを作成します。

分析ルールでは、環境全体にわたる特定のイベントまたは一連のイベントを検索したり、特定のイベントしきい値または条件に達したときはユーザーに警告したり、SOC でトリアージと調査を行うためのインシデントを生成したり、自動化された追跡および修復プロセスを使用して脅威に対応したりします。

>**重要:** ラーニング パス #9 のラボ演習は、*スタンドアロン*環境にあります。 ラボを完了せずに終了する場合は、構成を再実行する必要があります。

### このラボの推定所要時間: 45 分

>**注:** Microsoft Sentinel は、**defenderWorkspace** という名前で Azure サブスクリプションに事前にデプロイされており、必要な *Content Hub* ソリューションがインストールされています。

<!--- >>**Important:** To sucessfully complete this task you wil need to rerun Task 3 of **[Lab 08 Exercise 1](https://microsoftlearning.github.io/SC-200T00A-Microsoft-Security-Operations-Analyst/Instructions/Labs/LAB_AK_08_Lab1_Ex01_Connect_Services.html)** to connect the Azure Activity data connector. --->

このタスクをきちんと完了するには、次の前提条件タスクを完了する必要があります。

### 前提条件タスク: Azure アクティビティ データ コネクタを接続する

このタスクでは、*Azure Activity* データ コネクタを接続します。

1. Microsoft Sentinel ナビゲーション メニューで、*[コンテンツ管理]* セクションまで下にスクロールし、**[コンテンツ ハブ]** を選択します。

1. *[コンテンツ ハブ]* で、「**Azure Activity**」ソリューションを検索し、一覧から選択します。

1. *[Azure アクティビティ]* ソリューションの詳細ページで、**[管理]** を選択します。

    >**注:** *Azure Activity* ソリューションでは、*Azure Activity* データ コネクタ、12 個の分析ルール、14 個のハンティング クエリ、1 つのブックがインストールされます。

1. *Azure Activity* データ コネクタを選択し、 **[コネクタ ページを開く]** を選択します。

1. *[構成]* 領域の *[手順]* タブで、"2. 診断設定の新しい..." まで下にスクロールし、 **[[Azure Policy の割り当て] ウィザードの起動>]** を選択します。

1. **[基本]** タブで、**[スコープ]** の下にある省略記号ボタン ([...]) を選択し、ドロップダウン リストから *MOC Subscription-XXXXXXXXXXX* サブスクリプションを選択して、**[選択]** をクリックします。

1. **[パラメーター]** タブを選択し、 **[プライマリ Log Analytics ワークスペース]** ドロップダウン リストから自分の *uniquenameDefender* ワークスペースを選択します。 このアクションにより、Log Analytics ワークスペースに情報を送信するサブスクリプション構成が適用されます。

1. **[修復]** タブを選択し、 **[修復タスクの作成]** チェック ボックスをオンにします。 このアクションにより、既存の Azure リソースにポリシーが適用されます。

1. **[確認と作成]** ボタンを選択して構成を確認します。

1. **[作成]** を選択して完了します。

1. 続行する前に、*Azure アクティビティ* データ コネクタが *[接続済み]* 状態と表示されるまで待ってください。

### タスク 1: スケジュールされたクエリ ルールを作成する

このタスクでは、*Microsoft Sentinel 分析のスケジュールされたクエリ ルール*を作成します。

>**注:** 次のタスクは現在 Azure プレビュー ポータル (<https://preview.portal.azure.com/>) で最適に機能します。

1. 管理者として WIN1 仮想マシンにログインします。パスワードは**Pa55w.rd**。  

1. **[サインイン]** ダイアログ ボックスで、ラボ ホスティング プロバイダーから提供された**テナントの電子メール** アカウントをコピーして貼り付け、 **[次へ]** を選択します。

1. **[パスワードの入力]** ダイアログ ボックスで、ラボ ホスティング プロバイダーから提供された**テナントのパスワード**をコピーして貼り付け、 **[サインイン]** を選択します。

1. Azure portal の検索バーに「*Sentinel*」と入力してから、**[Microsoft Sentinel]** を選択します。

1. Microsoft Sentinel **defenderWorkspace** を選択します。

1. 構成領域から **[分析]** を選択します。

1. コマンド バーの [規則のテンプレート] タブにいることを確認し、 **[New CloudShell User] (新しい CloudShell ユーザー)** 規則を検索します。**

1. ルールの概要ブレードで、 *[データ ソース: Azure アクティビティ]* の下にある緑色のアイコンを調べて、データを受信していることを確認します。

    >**注:** 接続状態として表示されておらず、上記の*前提条件タスク*を実行した場合は、プロセスが完了するまで長く待つ必要がある場合があります。

1. **[ルールの作成]** を選んで続けます。

1. 分析ルール ウィザードの [全般] タブで、[重大度] を **[中]** に変更します。** **

1. **[次へ: ルール ロジックを設定 >]** ボタンを選択します。

1. ルール クエリで、 **[クエリ結果の表示]** を選びます。 結果やエラーは表示されないはずです。

1. 右上の **[X]** を選択して *[ログ]* ウィンドウを閉じ、 **[OK]** を選択して変更を破棄して保存し、ウィザードに戻ります。

1. 下にスクロールし、 *[クエリのスケジュール設定]* で次のように設定します。

    |設定|値|
    |---|---|
    |クエリの実行間隔|5 分|
    |次の時間分の過去のデータを参照します|1 日|

    >**注:**  同じデータに対して意図的に多くのインシデントを生成しています。 これにより、ラボはこれらのアラートを使用できるようになります。

1. *[アラートのしきい値]* 領域では、アラートですべてのイベントを登録するため、値はそのままにしておきます。

1. *[イベントのグループ化]* 領域では、 **[すべてのイベントを単一のアラートにグループ化する]** オプションを選択したままにしておきます。これは、クエリから、上記の指定されたアラートのしきい値よりも多くの結果が返される場合に限り、実行するたびに単一のアラートを生成する必要があるためです。

1. 下部にある **[次: インシデント設定 >]** ボタンを選択します。

1. *[インシデント設定]* タブで、既定のオプションを確認します。

1. 下部にある **[次: 自動応答 >]** ボタンを選択します。

1. **[次へ: 確認と作成 >]** ボタンを選択します。
  
1. **[保存]** を選択します。

### タスク 2: 新しいルールを編集する

1. Azure portal の検索バーに「*Sentinel*」と入力してから、**[Microsoft Sentinel]** を選択します。

1. Microsoft Sentinel ワークスペースを選択します。

1. 構成領域から **[分析]** を選択します。

1. コマンド バーの *[アクティブな規則]* タブにいることを確認したうえで、**[新しい CloudShell ユーザー]** 規則を選択します。

1. この規則を右クリックし、*ポップアップ* メニューから **[編集]** を選択します。

1. **[次へ: ルール ロジックを設定 >]** ボタンを選択します。

1. 下部にある **[次: インシデント設定 >]** ボタンを選択します。

1. 下部にある **[次: 自動応答 >]** ボタンを選択します。

1. *[オートメーション ルール]* の下の *[自動応答]* タブで、**[新規追加]** を選択します。

1. *[Automation ルール名]* に「**Tier 2**」と入力します。

1. *[アクション]* で、 **[所有者の割り当て]** を選択します。

1. 次に、 **[自分に割り当てる]** を選択します。

1. **[適用]** を選択します

1. **[次へ: 確認と作成 >]** ボタンを選択します。
  
1. **[保存]** を選択します。

### タスク 3: 新しいルールをテストする

このタスクでは、新しくスケジュールされたクエリ ルールをテストします。

1. Azure portal の上部バーで、Cloud Shell に対応するアイコン **>_** を選びます。 ディスプレイの解像度が低すぎる場合は、最初に省略記号アイコン **[...]** の選択が必要な場合があります。

1. *[Azure Cloud Shell へようこそ]* ウィンドウで **[PowerShell]** を選択します。

1. *[作業の開始]* ページで、**[ストレージ アカウントをマウントする]** を選択し、*ストレージ アカウント サブスクリプション*のドロップダウン メニュー項目から使用する **[MOC Subscription-XXXXXXXXXXX]** を選択し、**[適用]** ボタンを選択します。

    >**重要:***[ストレージ アカウントは必要ありません]* オプション ボタンのオプションは選択しないでください。 これは、インシデントの作成が失敗する原因になります。

1. *[ストレージ アカウントのマウント]* ページで、**[自動でストレージ アカウントを作成します]** を選択した後、**[次へ]** を選択します。

1. Cloud Shell がプロビジョニングされるまで待った後、Azure Cloud Shell ウィンドウを閉じます。

1. Azure portal の検索バーに「アクティビティ」と入力し、 **[アクティビティ ログ]** を選びます。**

1. [操作名] の項目に **[ストレージ アカウント キーの一覧表示]** と **[Update Storage Account Create] (ストレージ アカウントの作成の更新)** が表示されていることを確認します。** これらは、前に確認した KQL クエリがアラートを生成するために一致する操作です。 **ヒント:** **[最新の情報に更新]** を選んで一覧を更新することが必要な場合があります。

1. Azure portal の検索バーに「*Sentinel*」と入力してから、**[Microsoft Sentinel]** を選択します。

1. Microsoft Sentinel ワークスペースを選択します。

1. **[脅威の管理]** の *[インシデント]* メニュー オプションを選択します。

1. **[インシデントの自動更新]** トグルを選択します。

1. 新しく作成したインシデントが表示されます。

    >**注:** インシデントをトリガーするイベントは、処理に 5 分以上かかることがあります。 次の演習に進んでください。このビューには後で戻ります。

1. インシデントを選択し、右側のブレードの情報を確認します。

## 演習 4 に進む
