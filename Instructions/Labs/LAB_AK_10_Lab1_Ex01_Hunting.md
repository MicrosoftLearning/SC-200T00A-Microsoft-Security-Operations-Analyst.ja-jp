---
lab:
  title: 演習 1 - Microsoft Sentinel で脅威ハンティングを実行する
  module: Learning Path 10 - Perform threat hunting in Microsoft Sentinel
---

# ラーニング パス 10 - ラボ 1 - 演習 1 - Microsoft Sentinel で脅威ハンティングを実行する

## ラボのシナリオ

![ラボの概要。](../Media/SC-200-Lab_Diagrams_Mod8_L1_Ex1.png)

あなたは Microsoft Sentinel を実装した企業で働いているセキュリティ運用アナリストです。 コマンドと制御 (C2 または C&C) 手法に関する脅威インテリジェンスを受け取りました。 その脅威に対して捜索とウォッチを実行する必要があります。

>**重要:** ラーニング パス #10 のラボ演習は、*スタンドアロン*環境にあります。 ラボを完了せずに終了する場合は、構成を再実行する必要があります。

ラーニング パス 9 のラボ演習で作成したログ データは、次の前提条件タスクを再実行しないとこのラボでは使用できません。

<!--- **[Lab 09 Exercise 5](https://microsoftlearning.github.io/SC-200T00A-Microsoft-Security-Operations-Analyst/Instructions/Labs/LAB_AK_09_Lab1_Ex05_Attacks.html)**

**[Lab 09 Exercise 6](https://microsoftlearning.github.io/SC-200T00A-Microsoft-Security-Operations-Analyst/Instructions/Labs/LAB_AK_09_Lab1_Ex06_Perform_Attacks.html)** --->

### このラボの推定所要時間: 45 分から 60 分

### 前提条件タスク 1: オンプレミスのサーバーを接続する

このタスクでは、オンプレミスのサーバーを Azure サブスクリプションに接続します。 Azure Arc は、このサーバーにプレインストールされています。 後で Microsoft Sentinel で検出と調査を行うシミュレートされた攻撃を実行するために、サーバーは次の演習で使用されます。

>**重要:** 次の手順は、以前に作業していたものとは異なるマシンで行います。 参照タブで仮想マシン名を探します。

1. 管理者として **WINServer** 仮想マシンにログインします。パスワードは **Passw0rd!** です。 必要に応じて。  

前述のように、Azure Arc は **WINServer** マシンにプレインストールされています。 これで、このマシンを Azure サブスクリプションに接続します。

1. *WINServer* マシンで、*検索*アイコンを選択し、**cmd** と入力します。

1. 検索結果の*コマンド プロンプト*を右クリックし、**[管理者として実行]** をクリックします。

1. コマンド プロンプト ウィンドウで、次のコマンドを入力します。 *Enter キーを押さないでください*

    ```cmd
    azcmagent connect -g "defender-RG" -l "EastUS" -s "Subscription ID string"
    ```

1. **サブスクリプション ID 文字列** を、ラボ ホスト (*リソース タブ) から提供された *サブスクリプション ID* に置き換えます。 引用符は保持してください。

1. **Enter** を入力してコマンドを実行します (これには数分かかる場合があります)。

    >**注**: *[このファイルを開く方法を選んでください]* というブラウザー選択ウィンドウが表示される場合は、**[Microsoft Edge]** を選択します。

1. *[サインイン]* ダイアログ ボックスに、ラボ ホスティング プロバイダーから提供された**テナントのメール アドレス**と**テナントのパスワード**を入力して、**[サインイン]** を選択します。 *認証が完了*したというメッセージが表示されるまで待ち、ブラウザー タブを閉じて、*コマンド プロンプト* ウィンドウに戻ります。

1. コマンドの実行が完了したら、*コマンド プロンプト* ウィンドウを開いたままにし、次のコマンドを入力して接続が成功したことを確認します。

    ```cmd
    azcmagent show
    ```

1. コマンド出力で、*Agent status* が **Connected** であることを確認します。

## 前提条件タスク 2: Azure 以外の Windows マシンを接続する

このタスクでは、Azure Arc に接続されたオンプレミスのマシンを、Microsoft Sentinel に追加します。  

>**注:** Microsoft Sentinel は、**defenderWorkspace** という名前で Azure サブスクリプションに事前にデプロイされており、必要な*コンテンツ ハブ* ソリューションがインストールされています。

1. 管理者として **WIN1** 仮想マシンにログインします。パスワードは **Pa55w.rd** です。  

1. Microsoft Edge ブラウザーで、Azure portal (<https://portal.azure.com> ) に移動します。

1. **サインイン** ダイアログ ボックスで、ラボ ホスティング プロバイダーから提供された**テナントの電子メール** アカウントをコピーして貼り付け、**[次へ]** を選択します。

1. **[パスワードの入力]** ダイアログ ボックスで、ラボ ホスティング プロバイダーから提供された**テナントパスワード**をコピーして貼り付け、**[サインイン]** を選択します。

1. Azure portal の検索バーに「*Sentinel*」と入力してから、**[Microsoft Sentinel]** を選択します。

1. Microsoft Sentinel **defenderWorkspace** を選択します。

1. Microsoft Sentinel の左側ナビゲーション メニューで、*[構成]* セクションまで下にスクロールし、**[データ コネクタ]** を選択します。

1. *[データ コネクタ]* で、「**AMA を使用した Windows セキュリティ イベント**」ソリューションを検索し、一覧から選択します。

1. *[AMA を使用した Windows セキュリティ イベント]* 詳細ウィンドウで、**[コネクタ ページを開く]** を選択します。

    >**注:** "Windows セキュリティ イベント" ソリューションでは、"AMA を使用した Windows セキュリティ イベント" と "レガシ エージェントを使用したセキュリティ イベント" データ コネクタの両方がインストールされます。** ** ** さらに、2 つのブック、20 個の分析ルール、43 個のハンティング クエリがインストールされます。

1. *[構成]* セクションの *[手順]* タブで、 **[データ収集ルールの作成]** を選択します。

1. ルール名に「**AZWINDCR**」と入力して、 **[次へ: リソース]** を選択します。

1. *[リソース]* タブの *[スコープ]* の下の *[サブスクリプション]* を展開します。

    >**ヒント:***[スコープ]* 列の前にある ">" を選択することで、*[スコープ]* 階層全体を展開できます。

1. **defender-RG** リソース グループを展開して、**WINServer** を選択します。

1. **[次へ: 収集]** を選択し、*[すべてのセキュリティ イベント]* を選択したままにします。

1. **[次へ: 確認と作成]** を選択します。

1. *[検証に成功しました]* が表示されたら、 **[作成]** を選択します。

### 前提条件タスク 3: DNS を使用したコマンド アンド コントロール攻撃

>**重要:** 次の手順は、以前に作業していたものとは異なるマシンで行います。 参照タブで仮想マシン名を探します。

1. 管理者として **WINServer** 仮想マシンにログインします。パスワードは **Passw0rd!** です。 必要に応じて。

1. *WINServer* マシンで、*検索*アイコンを選択し、**cmd** と入力します。

1. 検索結果の*コマンド プロンプト*を右クリックし、**[管理者として実行]** をクリックします。

1. 次のコマンドをコピーして実行し、C2 サーバーに対する DNS クエリをシミュレートするスクリプトを作成します。

    ```CommandPrompt
    notepad c2.ps1
    ```

1. **[はい]** を選択して新しいファイルを作成し、以下の PowerShell スクリプトを *c2.ps1* にコピーします。

    >**メモ:** 仮想マシン ファイルへの貼り付けでは、スクリプトの完全な長さが表示されない場合があります。 スクリプトが *c2.ps1* ファイル内で次の手順と同じであることを確認してください。

    ```PowerShell
    param(
        [string]$Domain = "microsoft.com",
        [string]$Subdomain = "subdomain",
        [string]$Sub2domain = "sub2domain",
        [string]$Sub3domain = "sub3domain",
        [string]$QueryType = "TXT",
        [int]$C2Interval = 8,
        [int]$C2Jitter = 20,
        [int]$RunTime = 240
    )
    $RunStart = Get-Date
    $RunEnd = $RunStart.addminutes($RunTime)
    $x2 = 1
    $x3 = 1 
    Do {
        $TimeNow = Get-Date
        Resolve-DnsName -type $QueryType $Subdomain".$(Get-Random -Minimum 1 -Maximum 999999)."$Domain -QuickTimeout
        if ($x2 -eq 3 )
        {
            Resolve-DnsName -type $QueryType $Sub2domain".$(Get-Random -Minimum 1 -Maximum 999999)."$Domain -QuickTimeout
            $x2 = 1
        }
        else
        {
            $x2 = $x2 + 1
        }    
        if ($x3 -eq 7 )
        {
            Resolve-DnsName -type $QueryType $Sub3domain".$(Get-Random -Minimum 1 -Maximum 999999)."$Domain -QuickTimeout
            $x3 = 1
        }
        else
        {
            $x3 = $x3 + 1
        }
        $Jitter = ((Get-Random -Minimum -$C2Jitter -Maximum $C2Jitter) / 100 + 1) +$C2Interval
        Start-Sleep -Seconds $Jitter
    }
    Until ($TimeNow -ge $RunEnd)
    ```

1. メモ帳のメニューで、 **[ファイル]** 、 **[保存]** の順に選択します。 

1. コマンド プロンプト ウィンドウに戻り、次のコマンドを入力して Enter キーを押します。 

    >**注:** DNS 解決エラーが表示されます。 これは予期されることです。

    ```CommandPrompt
    Start PowerShell.exe -file c2.ps1
    ```

>**重要:** これらのウィンドウを閉じないでください。 この PowerShell スクリプトをバックグラウンドで実行させておきます。 コマンドは、数時間ログエントリを生成する必要があります。 このスクリプトの実行中に次のタスクや次の演習に進むことができます。 このタスクで作成したデータは、後で脅威の捜索ラボで使用します。 このプロセスでは、大量のデータや処理を作成することはありません。

### タスク 1:ハンティング クエリの作成

このタスクでは、ハンティング クエリの作成、結果のブックマーク、ライブ ストリームの作成を行います。

>**注:** Microsoft Sentinel は、**defenderWorkspace** という名前で Azure サブスクリプションに事前にデプロイされており、必要な *Content Hub* ソリューションがインストールされています。

1. 管理者として WIN1 仮想マシンにログインします。パスワードは**Pa55w.rd**。  

1. Microsoft Edge ブラウザーで、Azure portal (<https://portal.azure.com> ) に移動します。

1. **[サインイン]** ダイアログ ボックスで、ラボ ホスティング プロバイダーから提供された**テナントの電子メール** アカウントをコピーして貼り付け、 **[次へ]** を選択します。

1. **[パスワードの入力]** ダイアログ ボックスで、ラボ ホスティング プロバイダーから提供された**テナントのパスワード**をコピーして貼り付け、 **[サインイン]** を選択します。

1. Azure portal の検索バーに「*Sentinel*」と入力してから、**[Microsoft Sentinel]** を選択します。

1. Microsoft Sentinel **defenderWorkspace** を選択します。

1. **[ログ]** を選択します。

1. *[新しいクエリ 1]* スペースに以下の KQL ステートメントを入力します。

   >**重要:** 最初に KQL クエリをメモ帳に貼り付けて、そこから *[新しいクエリ 1]* ログ ウィンドウにコピーしてエラーを回避してください。

    ```KQL
    let lookback = 2d; 
    SecurityEvent 
    | where TimeGenerated >= ago(lookback) 
    | where EventID == 4688 and Process =~ "powershell.exe"
    | extend PwshParam = trim(@"[^/\\]*powershell(.exe)+" , CommandLine) 
    | project TimeGenerated, Computer, SubjectUserName, PwshParam 
    | summarize min(TimeGenerated), count() by Computer, SubjectUserName, PwshParam 
    | order by count_ desc nulls last 
    ```

1. さまざまな結果を確認します。 これで、環境内で実行されている PowerShell 要求が特定されました。

1. *"-file c2.ps1"* を示す結果のチェック ボックスをオンにします。

1. *[結果]* ウィンドウのコマンド バーで、**[ブックマークの追加]** ボタンを選択します。

1. *[エンティティ マッピング]* で **[+ 新しいエンティティの追加]** を選択します。

1. *[エンティティ]* で、 **[ホスト]** を選択してから、その値として **[ホスト名]** と **[コンピューター]** を選びます。

1. *[戦術と手法]* で、 **[コマンドとコントロール]** を選択します。

1. *[ブックマークの追加]* ブレードで、**[作成]** を選択します。 このブックマークは後でインシデントにマップします。

1. ウィンドウの右上にある **[X]** を選択して *[ログ]* ウィンドウを閉じ、 **[OK]** を選択して変更を破棄します。 

1. Microsoft Sentinel ワークスペースをもう一度選択し、 *[脅威の管理]* 領域で **[ハンティング]** ページを選択します。

1. コマンド バーから **[クエリ]** タブ、 **[+ 新しいクエリ]** の順に選択します。

1. *[カスタム クエリの作成]* ウィンドウで、 *[名前]* に「**PowerShell ハント**」と入力します。

1. *カスタム クエリ*には、次の KQL ステートメントを入力します。

    ```KQL
    let lookback = 2d; 
    SecurityEvent 
    | where TimeGenerated >= ago(lookback) 
    | where EventID == 4688 and Process =~ "powershell.exe"
    | extend PwshParam = trim(@"[^/\\]*powershell(.exe)+" , CommandLine) 
    | project TimeGenerated, Computer, SubjectUserName, PwshParam 
    | summarize min(TimeGenerated), count() by Computer, SubjectUserName, PwshParam 
    | order by count_ desc nulls last 
    ```

1. 下にスクロールし、 *[エンティティ マッピング]* で次のように選択します。

    - *[エンティティの種類]* ドロップダウン リストで、**[ホスト]** を選択します。
    - *[識別子]* ドロップダウン リストで、**[HostName]** を選択します。
    - *[値]* ドロップダウン リストで、 **[コンピューター]** を選択します。

1. 下にスクロールし、*[戦術と手法]* で **[コマンドと制御]** を選び、**[作成]** を選択してハンティング クエリを作成します。

1. *[Microsoft Sentinel | ハンティング]* ブレードで、先ほど作成したクエリ *PowerShell ハント*をリストで探します。

1. リストから **[PowerShell ハント]** を選択します。

1. 中央のペインの *[結果]* 列で結果の数を確認します。

1. 右側のペインから **[結果の表示]** ボタンを選択します。 KQL クエリが自動的に実行されます。

1. ウィンドウの右上にある **[X]** を選択して *[ログ]* ウィンドウを閉じ、 **[OK]** を選択して変更を破棄します。 

1. **[PowerShell ハント]** を右クリックし、 **[ライブストリームに追加]** を選択します。 **ヒント:** これは、右にスライドし、行の末尾にある省略記号 **(...)** を選択してコンテキスト メニューを開くことで行うこともできます。

1. *[状態]* が *[実行中]* になったことを確認します。 これはバックグラウンドで 30 秒ごとに実行され、新しい結果が見つかると Azure ポータル (ベル アイコン) で通知が届きます。 

1. 中央のペインで **[ブックマーク]** タブを選択します。

1. 結果リストから作成したブックマークを選択します。

1. 右側のペインで下にスクロールし、 **[調査]** ボタンを選択します。 **ヒント:** 調査グラフを表示するには数分かかる場合があります。

1. 前のモジュールで行ったのと同じように調査グラフを調べます。 *WINServer* の *[関連するアラート]* の数が多いことに注目してください。

1. ウィンドウの右上にある **[X]** を選択して、 *[調査]* グラフ ウィンドウを閉じます。 

1. **[>>]** アイコンを選択して右側のブレードを非表示にし、省略記号 **(...)** アイコンが表示されるまで右にスクロールします。

1. **[既存のインシデントに追加]** を選択します。 すべてのインシデントが右側のペインに表示されます。

1. インシデントの 1 つを選んでから、 **[追加]** を選択します。

1. 左にスクロールして、 *[重大度]* 列にインシデントのデータが設定されていることに注目します。

### タスク 2: NRT クエリ ルールを作成する

このタスクでは、LiveStream を使用する代わりに、NRT 分析クエリ ルールを作成します。 NRT ルールは 1 分ごとに実行され、1 分間ルックバックされます。 NRT ルールの利点は、アラートとインシデント作成ロジックを使用できることです。

1. Microsoft Sentinel で *[構成]* の **[分析]** ページを選択します。 

1. **[作成]** タブを選択し、**[NRT クエリ ルール]** を選択します。

1. これで [分析ルール ウィザード] が起動します。 *[全般]* タブで、次のように入力します。

    |設定|値|
    |---|---|
    |名前|**NRT PowerShell ハント**|
    |説明|**NRT PowerShell ハント**|
    |方針|**コマンドとコントロール**|
    |Severity|**高**|

1. **[次へ: ルール ロジックを設定]** ボタンを選択します。 

1. *[ルール クエリ]* に次の KQL ステートメントを入力します。

    ```KQL
    let lookback = 2d; 
    SecurityEvent 
    | where TimeGenerated >= ago(lookback) 
    | where EventID == 4688 and Process =~ "powershell.exe"
    | extend PwshParam = trim(@"[^/\\]*powershell(.exe)+" , CommandLine) 
    | project TimeGenerated, Computer, SubjectUserName, PwshParam 
    | summarize min(TimeGenerated), count() by Computer, SubjectUserName, PwshParam
    ```

1. **[クエリ結果の表示 >]** を選択して、クエリにエラーがないことを確認します。

1. ウィンドウの右上にある **[X]** を選択して *[ログ]* ウィンドウを閉じ、 **[OK]** を選択して変更を破棄します。 

1. *[結果のシミュレーション]* の **[現在のデータでテストする]** を選択します。 *[1 日あたりのアラート]* の予想される数に注目してください。

1. *[警告の拡張機能]* セクションで、*[エンティティ マッピング >]*、**[+ 新しいエンティティの追加]** を選択します。

1. *[エンティティ]* で次を選択します。

    - *[エンティティの種類]* ドロップダウン リストで、**[ホスト]** を選択します。
    - *[識別子]* ドロップダウン リストで、**[HostName]** を選択します。
    - *[値]* ドロップダウン リストで、 **[コンピューター]** を選択します。

1. 下にスクロールし、 **[次へ: インシデント設定>]** ボタンを選択します。

1. *[インシデント設定]* タブについては、既定値のままにし、**[次へ: 自動応答 >]** ボタンを選択します。

1. *[自動応答]* タブで、**[次へ: 確認と作成 >]** ボタンを選択します。

1. *[確認と作成]* タブで、 **[保存]** ボタンを選択して、新しいスケジュール化された分析ルールを作成して保存します。

### タスク 3: 検索ジョブの作成

このタスクでは、検索ジョブを使用して C2 を検索します。

**注:** *復元*操作ではコストが発生し、Azure サブスクリプション クレジットを完全に消費する可能性があります。 そのため、このラボでは復元操作は実行しません。 ただし、次の手順に従って、独自の環境で復元操作を実行できます。

1. Microsoft Sentinel で、 *[全般]* の **[検索]** ページを選択します。

1. 検索ボックスに「**reg.exe**」と入力してから、 **[スタート]** を選択します。

1. クエリを実行している新しいウィンドウが開きます。 右上にある省略記号アイコン **(...)** を選択し、 **[検索ジョブ モード]** を切り替えます。

1. コマンド バーから **[検索ジョブ]** ボタンを選択します。 

1. 検索ジョブでは、結果が到着するとすぐに新しいテーブルが作成されます。 結果は、 *[保存された検索条件]* タブから確認できます。

1. ウィンドウの右上にある **[X]** を選択して *[ログ]* ウィンドウを閉じ、 **[OK]** を選択して変更を破棄します。

1. コマンド バーから **[復元]** タブを選び、 **[復元]** ボタンを選択します。

1. *[復元するテーブルの選択]* で、**SecurityEvent** を検索して選択します。

1. 使用可能なオプションを確認し、[**キャンセル**] ボタンを選択します。

    >**注:** ジョブを実行している場合、復元は数分実行され、データは新しいテーブルで使用できるようになります。

### タスク 4: 複数のクエリを MITRE 戦術に統合するハントを作成する

1. MITRE ATT&CK マップは、検出範囲の特定のギャップを特定するのに役立ちます。 特定の MITRE ATT&CK 手法のための事前定義されたハンティング クエリを、新しい検出ロジックを開発するための開始点として使用します。

1. Microsoft Sentinel の左側のナビゲーション メニューで、**[脅威の管理]** を展開します。

1. **[MITRE ATT&CK (プレビュー)]** を選択します。

1. *[アクティブな規則]* ドロップダウン メニューの項目を選択解除します。

1. *[シミュレート済み規則]* フィルターで **[ハンティング クエリ]** を選択して、ハンティング クエリが関連付けられている手法を確認します。

1. **アカウント操作**のカードを選択します。

1. 詳細ウィンドウで *[シミュレートされたカバレッジ]* を探して、*[ハンティング クエリ]* の横にある **[表示]** リンクを選択します。

1. このリンクをクリックすると、選択した手法に基づいて、[ハンティング] ページの [クエリ] タブのフィルター処理されたビューが表示されます。

1. 左側の一覧の先頭付近にあるボックスを選択して、その手法のすべてのクエリを選択します。

1. フィルターの上の画面中央付近にある **[ハント アクション]** ドロップダウン メニューを選択します。

1. **[ハントの作成]** を選択します。 選択したすべてのクエリが、この新しいハント用に複製されます。

1. ハント名とオプションのフィールドに入力します。 説明は、仮説を言葉で表すのに適した場所です。 [仮説] プルダウン メニューでは、作業中の仮説の状態を設定します。

1. **[作成]** を 選択して作業を開始します。

1. **[Hunts (Preview)] (ハント (プレビュー))** タブを選択して、新しいハントを表示します。

1. 詳細を表示してアクションを実行するハント リンクの名前を選択します。

1. [ハント名]、[説明]、[コンテンツ]、[最終更新時刻]、[作成時刻] を示す詳細ウィンドウを表示します。

1. *クエリ*列の横にあるボックスを使用して、すべてのクエリを選択します。

1. **[選択したクエリの実行]** を選択するか、選択した行をクリアして 1 つのクエリを*右クリック*し **[実行]** を選択します。

1. 1 つのクエリを選択し、詳細ウィンドウで **[結果の表示]** を選択することもできます。

1. 結果を返したクエリを確認します。

1. 結果に基づいて、仮説を検証するのに十分な強力な証拠があるかどうかを判断します。 ない場合は、ハントを閉じ無効としてマークします。

1. または、次の手順に従います。
    - Microsoft Sentinel に移動します。
    - [脅威の管理] を展開します。
    - [ハンティング] を選びます。
    - [フィルターの追加] を選択します。
    - このフィルターを tactics:persistence に設定します。
    - 別のフィルターを追加します。
    - 2 番目のフィルターに techniques: T1098 を設定します。

## 演習 2 に進みます。
