---
lab:
  title: 演習 11 - Microsoft Sentinel でリポジトリを使用する
  module: Learning Path 7 - Create detections and perform investigations using Microsoft Sentinel
---

# <a name="learning-path-7---lab-1---exercise-11---use-repositories-in-microsoft-sentinel"></a>ラーニング パス 7 - ラボ 1 - 演習 11 - Microsoft Sentinel でリポジトリを使用する

## <a name="lab-scenario"></a>ラボのシナリオ

あなたは、Microsoft Sentinel を実装した会社で働いているセキュリティ運用アナリストです。 あなたはスケジュール済みおよび Microsoft セキュリティ分析ルールを既に作成しています。  Azure DevOps リポジトリで分析ルールを一元化する必要があります。  次に、Sentinel を Azure DevOps リポジトリに接続し、コンテンツをインポートします。 


### <a name="task-1-create-and-export-an-analytical-rule"></a>タスク 1:分析ルールを作成してエクスポートする

このタスクでは、Microsoft Sentinel でエンティティ行動分析を有効にします。

1. 管理者として WIN1 仮想マシンにログインします。パスワードは**Pa55w.rd**。  

1. **[サインイン]** ダイアログ ボックスで、ラボ ホスティング プロバイダーから提供された**テナントの電子メール** アカウントをコピーして貼り付け、 **[次へ]** を選択します。

1. **[パスワードの入力]** ダイアログ ボックスで、ラボ ホスティング プロバイダーから提供された**テナントのパスワード**をコピーして貼り付け、 **[サインイン]** を選択します。

1. Azure portal の検索バーに「*Sentinel*」と入力し、**[Microsoft Sentinel]** を選択します。

1. Microsoft Sentinel ワークスペースを選択します。

1. 構成領域から **[分析]** を選択します。

1. **[+ 作成]** ボタンを選択してから、 **[スケジュールされたクエリ ルール]** を選びます。

1. 分析ルール ウィザードの [全般] タブで、「**Rule from Azure DevOps**」という名前を入力します。

1. [戦術] では、 **[永続化]** を選択します。

1. [重要度] では、 **[低]** を選択します。

1. **[次へ: ルール ロジックを設定 >]** ボタンを選択します。

1. ルールクエリの場合は、次のKQLステートメントを貼り付けます。

    >**警告:** 仮想マシンへの貼り付け機能を使用すると、余分な (パイプ) 文字が追加される場合があります。 必ず、最初にメモ帳を使用して、次のクエリを貼り付けてください。

    ```KQL
    SecurityEvent | where EventID == 4732
    ```

1. **[View query results](クエリ結果の表示)** を選択します。 結果やエラーは表示されないはずです。 エラーが表示される場合は、前の KQL ステートメントと同じようにクエリが表示されていることを確認してください。 右上の **[X]** を選択して *[ログ]* ウィンドウを閉じ、 **[OK]** を選択して変更を破棄して保存し、ウィザードに戻ります。


1. 下にスクロールし、 *[クエリのスケジュール設定]* で次のように設定します。

    |設定|値|
    |---|---|
    |クエリの実行間隔|5 分|
    |過去のデータを見る|1 日|

    >**注:**  同じデータに対して意図的に多くのインシデントを生成しています。 これにより、ラボはこれらのアラートを使用できるようになります。

1. *[アラートのしきい値]* 領域では、アラートですべてのイベントを登録するため、値はそのままにしておきます。

1. *[イベントのグループ化]* 領域では、 **[すべてのイベントを単一のアラートにグループ化する]** オプションを選択したままにしておきます。これは、クエリから、上記の指定されたアラートのしきい値よりも多くの結果が返される場合に限り、実行するたびに単一のアラートを生成する必要があるためです。

1. 下部にある **[次: インシデント設定 >]** ボタンを選択します。 

1. 下部にある **[次: 自動応答 >]** ボタンを選択します。

1. 下部にある **[次: 確認 >]** ボタンを選択します。
 
1. **［作成］** を選択します

1. 作成したルールを選択し、ツール バーから **[エクスポート]** を選択します。

1. 作成したルールを選択し、 **[削除]** を選択します。


### <a name="task-2-create-our-azure-devops-environment"></a>タスク 2:Azure DevOps 環境を作成する

このタスクでは、Azure DevOps リポジトリの作成と設定をテストします。

1. ブラウザーで別のタブを開きます。

1. https://aexprodcus1.vsaex.visualstudio.com/me?mkt=en-US に移動します。

1. *[We need a few more details](詳細情報をいくつか入力する必要があります)* ページで、 **[続行]** を選びます。

1. *[Azure DevOps の使用を開始する]* ページで、 **[新しい組織の作成]** 、 **[続行]** の順に選択します。

1. *[まもなく完了します]* ページで、今後使用しない DevOps 組織の名前 (テナント プレフィックスなど) を入力します。 **ヒント:** ご自分のラボの [リソース] タブにあります (WWLx...)。

1. *"表示される文字を入力し"* 、 **[続行]** します。

1. *[プロジェクトを作成して開始します]* ページで、「**My Sentinel コンテンツ**」と入力し、 **[プロジェクトの作成]** を選択します。

1. 左側のペインで**リポジトリ**に移動します。

1. ページの下部にある *[Initialize main branch with a README or gitignore](README または gitignore を使用してメイン ブランチを初期化する)* 領域で、 **[初期化]** を選択します。

1. ページに、リポジトリのファイルが表示されます。  唯一のファイルは README.me です。

1. [ファイル] (ページの右側) ブレードのツール バーには、 *[ビルドのセットアップ]* 、 *[クローン]* 、 *[:]* の各オプションが含まれています。  **[:]** を選択すると、その他のオプションが表示されます。

1. **[ファイルのアップロード]** を選択します。

1. **[参照]** を選択し、 *"ダウンロード"* ディレクトリからファイル **Azure_Sentinel_analytic_rule.json** を選択します。

1. **[コミット]** を選択します。

1. ページの左上隅にある **[Azure DevOps]** を選択します。  これにより、組織とプロジェクトが表示されます。

1. ページの左下にある **[組織の設定]** を選択します。

1. *[セキュリティ]* 領域で **[ポリシー]** を選択します。

1. *[アプリケーション接続ポリシー]* 領域で *[OAuth を使用したサード パーティ アプリケーションのアクセス]* を **[オン]** にします。


### <a name="task-3-connect-sentinel-to-azure-devops"></a>タスク 3:Sentinel を Azure DevOps に接続する。

1. ブラウザーで *[Azure portal]* / *[Microsoft Sentinel]* タブを選択します。

1. Microsoft Sentinel で、 *[コンテンツ管理]* セクションの **[リポジトリ (プレビュー)]** を選択します。

1. ツール バーから **[新規追加]** を選択します。

1. 名前に「**My Content**」と入力します。

1. ソース管理に対して、 **[Azure DevOps]** を選択します。

1. **[承認]** を選択します。 アクセス許可要求を下にスクロールし、 **[承諾]** を選択します。

1. 先ほど作成した組織 (WWLx など) を選択します。

1. 先ほど作成したプロジェクト、 *[My Sentinel コンテンツ]* を選択します。

1. 先ほど作成したリポジトリ、 *[My Sentinel コンテンツ]* を選択します。 **ヒント:** リポジトリを表示するには、ドロップダウン内で下にスクロールする必要がある場合があります。

1. **main** ブランチを選択します。 **ヒント:** ブランチを表示するには、ドロップダウン内で下にスクロールする必要がある場合があります。

1. すべてのコンテンツ タイプを選択します。

1. **[作成]** を選択します。

1. 必要に応じて Microsoft Sentinel ワークスペースに戻る

1. *[リポジトリ (プレビュー)]* ページに移動し、 **[更新]** を選択します。 *[最後の配置の状態]* が *[失敗]* になるまで待ちます。  

    >**注:** *[失敗]* の状態になるのは、ホストされているラボ環境の制限が原因です。 通常は *[成功]* と表示されます。 その後、 *[分析]* で、インポートされたルール *[Rule from Azure DevOps]* を確認できます。


## <a name="you-have-completed-the-lab"></a>これでラボは完了です。
